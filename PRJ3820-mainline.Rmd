---
title: "CycloneDamageAssessment-MainLine"
output: html_notebook
editor_options: 
  chunk_output_type: console
chunk_output_type: console
chunk_output_type: console
---



# Libraries and folders
# Settings, palletes, orders and include-lists

```{r}

library(raster)
library(exactextractr)
library(fasterize)

source("C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/Code/R/PRJ3820-DOC-GNSS/GNSS_utils.R")



proj_dn = "PRJ3820-DOC-GNSS/"


# identify the computer (and OS)
Current_PC <- Sys.info()["nodename"]

if (Current_PC == "EANZ-DT01-Linux") {
  root = paste0("C:/Users/McMillanAn/OneDrive - MWLR/Projects/",proj_dn)
  ncore_rec = 15
} else if (Current_PC == "EANZ-DT01") {
  root = paste0("C:/Users/McMillanAn/OneDrive - MWLR/Projects/", proj_dn)
  ncore_rec = 15
  
} else if (Current_PC == "styx") {
  root = paste0("/mnt/data/mcmillana/",proj_dn)
  ncore_rec = 64
} else if (Current_PC == "L-8P30JW3") {
  root = paste0("C:/Users/McMillanAn/OneDrive - MWLR/Projects/", proj_dn)
  ncore_rec = 18
} else {
  root = paste0("C:/Users/McMillanAn/OneDrive - MWLR/Projects/", proj_dn)
  ncore_rec = 15
}


datadir = paste0(root, "data/")
plotdir = paste0(root, "plots/")



Current_PC <- Sys.info()["nodename"]



util_script = paste0("C:/Users/McMillanAn/OneDrive - MWLR/Code/R/utils/", "mcm_sp_utils.R")
source(util_script)


cbbPalette <- c("#D55E00", "#56B4E9", "#CC79A7", "#009E73", "#000000", "#E69F00", "#56B4E9")

pegPalette <- c("#999999", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7")

# 
# CAR "#D55E00" 
# EML "#56B4E9" 
# JVD "#CC79A7" 
# TOP "#009E73" 
# R10 "#000000" 


```


# Load data

```{r}


LCDB = ea_load("LCDB")

GeodMkrs = st_read("C:/Users/McMillanAn/OneDrive - MWLR/NZ-Geospatial-Data/lds-nz-geodetic-marks-SHP/nz-geodetic-marks.shp")

RC = ea_load("RC")

LUCAS_PLOTS = st_read("C:/Users/McMillanAn/OneDrive - MWLR/NZ-Geospatial-Data/LUCAS-Plots/LucasPlots.shp")

roads = st_read("C:/Users/McMillanAn/OneDrive - MWLR/NZ-Geospatial-Data/lds-nz-road-centrelines-topo-150k-SHP/nz-road-centrelines-topo-150k.shp")



```

# Look only in RCs of interest

```{r}

RCofInt = RC %>% filter(REGC2022_1 == "ManawatÅ«-Whanganui Region" | REGC2022_1 == "Wellington Region")

RCofInt = RC %>% filter(REGC2022_1 == "Wellington Region")



mapview(RCofInt)

```

# Overlay with Indig Forest

```{r}

IF_in_RCofInt_ffn = paste0(datadir, "IF_in_RCofInt.gpkg")

if (recreate_IF_in_RCofInt){
  
  LCDB %>% select(Name_2018, Class_2018) %>% st_set_geometry(NULL) %>% distinct()
  IndigForest = LCDB %>% filter( Class_2018 == 54 | Class_2018 == 69)
  IF_in_RCofInt = st_intersection(IndigForest, RCofInt)
  
  st_write(IF_in_RCofInt, IF_in_RCofInt_ffn, append = F)
  
}else{
  IF_in_RCofInt = st_read(IF_in_RCofInt_ffn)
}

mapview(IF_in_RCofInt)

```

Find Geodetic Markers that fit the following conditions

1. Are less than D1 (say 500m) from boundary of forest
2. Are less than D2 (say 200m) from road

```{r}

#reduce markers just to RC_ofI


D1 = 250
D2 = 250


CRS_2193 = st_crs(LCDB)
GeodMkrs_2193 = st_transform(GeodMkrs,CRS_2193 )
roads_2193 = st_transform(roads,CRS_2193 )

mapview(roads_2193)

GM_RC = st_intersection(GeodMkrs_2193, RCofInt) %>% 
  filter(order<6)




roads_RC = st_intersection(roads_2193, RCofInt)
mapview(roads_RC)


#markers close to forest

GM_RC_buffer_D1 = st_buffer(GM_RC, D1)
GM_RC_near_forest_itx = st_intersects(GM_RC_buffer_D1, IF_in_RCofInt)
GM_RC_near_forest_ix = which(lengths(GM_RC_near_forest_itx )>0)
GM_RC_near_forest = GM_RC_buffer_D1[GM_RC_near_forest_ix,]

A = mapview(GM_RC_near_forest, col_region = "blue")
B = mapview(IF_in_RCofInt, col_region = "pink")

A + B
#makers close to road

GM_RC_buffer_D2 = st_buffer(GM_RC, D2)
GM_RC_near_road_itx = st_intersects(roads_RC,GM_RC_buffer_D2 )
GM_RC_near_road_ix = which(lengths(GM_RC_near_road_itx )>0)
GM_RC_near_road = GM_RC_buffer_D2[GM_RC_near_road_ix,]


near_road_and_forest_ix = intersect(GM_RC_near_forest_ix, GM_RC_near_road_ix)

GM_RC_near_road_and_forest = GM_RC_buffer_D2[near_road_and_forest_ix,]

mapview(GM_RC)

A = mapview(GM_RC_near_road, col.regions = "pink")
B = mapview(GM_RC_near_forest, col.regions = "grey")
C = mapview(GM_RC_near_road_and_forest, col.regions = "blue")

A + B + C



LUCAS_PLOTS_RC = st_intersection(LUCAS_PLOTS, RCofInt)
LUCAS_PLOTS_RC_buffer = st_buffer(LUCAS_PLOTS_RC,1000)

LUCAS_GM_RC_near_road_and_forest = st_intersection(LUCAS_PLOTS_RC_buffer,GM_RC_near_road_and_forest )

mapview(LUCAS_GM_RC_near_road_and_forest)

PO = ea_load("PO")

```


# Convert coords from CSRS-PPP output into NZTM2000

the units are in ITRF20(2023.8). epsg.io says that this CRS has an EPSG code of 9988
it says this crs replaces ITRF2014 (CRS code of 7789)
The Ellipsoid is GRS 1980


```{r}

library(sf)
library(tidyverse)

lat_dms = c(-40,20,10.56868)
lon_dms = c(175,48,45.45619)


dms2dd = function(ll_dms){
  
  ll_dd =  (abs(ll_dms[1]) + ll_dms[2]/60 + ll_dms[3]/3600) * sign(ll_dms[1])
  return(ll_dd)
}


# print(formatC(dms2dd(lat_dms), digits = 10))

ell_ht = 116.642

#create a point

LAT_9988 = dms2dd(lat_dms)
LON_9988 = dms2dd(lon_dms)

POS_DF = data.frame(lat = LAT_9988, lon = LON_9988) %>% as_tibble()

POS_DF_ffn = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/Field-Test-Ballance-20231030/EmlidReachRS2/CSRS-PPP/POS_DF.csv"

write_csv(POS_DF, POS_DF_ffn)
dir.exists( "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/Field-Test-Ballance-20231030/EmlidReachRS2/CSRS-PPP"
)


x = st_as_sf(POS_DF, coords = c("lat","lon"))



library(sp)
proj4string(x) <- CRS("+init=epsg:4326")





BAL_CBRX7_P1_LAT_DMS = c(-40, 20, 10.2156)
BAL_CBRX7_P1_LON_DMS = c(175, 48, 44.9934)
BAL_CBRX7_P1_EHT = 121.173

BAL_CBRX7_P1_LAT_DD = dms2dd(BAL_CBRX7_P1_LAT_DMS)
BAL_CBRX7_P1_LON_DD = dms2dd(BAL_CBRX7_P1_LON_DMS)

make_sf = function(lat, lon, crs, sf_type = "POINT"){
  
  tb = data.frame(lat = lat, lon = lon)
  
  sf = st_as_sf(tb, coords = c("lon", "lat"), crs = crs) %>% 
    st_cast(sf_type)
  
  
}






```

TOPCON Placed on P9


```{r}


LAT = 5466302.691
LON = 329664.409

POPAV_p9_TOPCON_SCRS = make_sf(LAT, LON, "epsg:32760")

POPAV_p9_TOPCON_SCRS_2193 = POPAV_p9_TOPCON_SCRS %>% st_transform("epsg:2193")

sprintf("%9.6f",st_coordinates(POPAV_p9_TOPCON_SCRS_2193)
)

```


# Read a CSRS-PPP output file

```{r}

ffn = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/Field-Test-Ballance-20231108/JVD/SOLUTIONS/CSRS-PPP/InitialAttempt-Occ1/BALOCC1P6_v2.pos"

D = read.delim(ffn, sep = "", skip=5) %>% as_tibble() %>% 
  mutate(
    DATETIME = paste(YEAR.MM.DD, HR.MN.SS.SS),
    PX = as.POSIXct(DATETIME, format = "%Y-%m-%d %H:%M:%S.%OS", tz = "UTC"),
    LAT_DECDEG = sign(LATDD)*(abs(LATDD) + LATMN/60 + LATSS/3600),
    LON_DECDEG = sign(LONDD)*(abs(LONDD) + LONMN/60 + LONSS/3600),
    minutes_elap = (as.numeric(PX)-as.numeric(PX[1]))/60)

D_sf = st_as_sf(D, coords = c("LON_DECDEG","LAT_DECDEG" ), crs = 4326)

mapview(D_sf)

D_sf_2193 = D_sf %>% st_transform(D_sf, crs = 2193)

NZTM_coords = st_coordinates(D_sf_2193) %>% as_tibble()

D = D %>% mutate(EASTING = NZTM_coords$X, NORTHING = NZTM_coords$Y)

names(D)

g = ggplot(D, aes(PX, NSV)) + geom_point()
g


g = ggplot(D, aes(PX, GDOP)) + geom_point()
g


g = ggplot(D, aes(PX, SDLAT.95..)) + geom_point()
g

g = ggplot(D, aes(PX, SDLON.95..)) + geom_point()
g

g = ggplot(D, aes(EASTING, NORTHING)) + geom_point(aes(color = minutes_elap))
g


ggplotly(g)






g = ggplot(D %>% filter(minutes_elap>60), aes(EASTING, NORTHING)) + geom_point(aes(color = minutes_elap))
g


ggplotly(g)





```

# Read the prelminary Total Station Data (total station data will be remeasured on 15/11/23)

```{r}



TS_data_ffn =  "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/Preliminary TS Points.shp/Preliminary TS Points.shp/Points.shp"
TS_data = st_read(TS_data_ffn)

TS_data_nogeo = TS_data %>% st_set_geometry(NULL)
TS_data_coords = st_coordinates(TS_data)

TS_data_df = TS_data_nogeo %>% bind_cols(TS_data_coords)
TS_data_df_ffn =  "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/TS_truth_points_prelim.csv"
write_csv(TS_data_df, TS_data_df_ffn)



```


# Convert the for the CSRS SolutionsWGS84 UTM Z60 to NZTM
```{r}



CSRS_Solutions_ffn =  "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/GNSS_DATA_COLLATED.csv"

CSRS_Solutions =  read_csv(CSRS_Solutions_ffn, skip = 5)
names(CSRS_Solutions)

CSRS_Solutions_coords_2193 = CSRS_Solutions %>% 
  filter(!is.na(CSRS_UTM_X)) %>% 
  st_as_sf(coords = c("CSRS_UTM_X", "CSRS_UTM_Y"), crs = 32760) %>% 
  st_transform(crs = 2193) %>% 
  st_coordinates() %>% 
  as_tibble()

CSRS_Solutions_2193_ffn = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/CSRS_2193.csv"
write_csv(CSRS_Solutions_coords_2193, CSRS_Solutions_2193_ffn)

```



```{r}

library(readxl)

xl_ffn = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/GNSS_DATA_COLLATED.xlsx"
xl_page = "BAL-FIELD-TEST-231108"
xl_rng = "A6:AO24"

D = readxl::read_excel(xl_ffn, sheet = xl_page, range = xl_rng)

D_mdf = D %>% 
  filter(!is.na(OCC_CODE)) %>% 
  select(OCC_CODE, contains("KNOWN"), contains("CSRS_UTM_"), CSRS_ELL_HT ) 


D_mdf_sf_2193_coords = D_mdf %>% 
  st_as_sf(coords = c("CSRS_UTM_X", "CSRS_UTM_Y"), crs = 32760) %>% 
  st_transform(crs = 2193) %>% 
  st_coordinates() %>% 
  as_tibble()

D_mdf = D_mdf %>% 
  mutate(
    NZTM_X = D_mdf_sf_2193_coords$X,
    NZTM_Y = D_mdf_sf_2193_coords$Y
  )


TRUTH_SF = D_mdf[1:5,] %>% 
  st_as_sf(coords = c("PEG_KNOWN_X", "PEG_KNOWN_Y"), crs = 2193) %>% 
  mutate(pegname = str_extract(OCC_CODE, "PEG\\d{1}$"))


CSRS_TRUTH_SF_ffn = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/CSRS_TRUTH_FINAL_SF.gpkg"
st_write(TRUTH_SF, CSRS_TRUTH_SF_ffn, append = F)

MEAS_SF =  D_mdf %>% 
  st_as_sf(coords = c("NZTM_X", "NZTM_Y"), crs = 2193) %>% 
  select(OCC_CODE)

CSRS_MEAS_SF_ffn = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/CSRS_MEAS_SF.gpkg"

st_write(MEAS_SF, CSRS_MEAS_SF_ffn, append = F)



library(leaflet)


A = mapview(TRUTH_SF, col.region = "white",color = "blue") %>% 
  addStaticLabels(label = TRUTH_SF$pegname,
                  noHide = TRUE,
                  direction = 'top',
                  textOnly = TRUE,
                  textsize = "20px")


B = mapview(MEAS_SF, col.region = "yellow", color = "red")

A+B

```


# READ TRUTH LOCATIONS

```{r}




#read the peg psoitions

KnownPegPositions_binary_ffn = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/KnownPegPositions.RDS"

if (reread_excel){
  KnownPegPositions = read_excel("C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/GNSS_DATA_COLLATED.xlsx", sheet = "PEGS-KNOWN-POSITIONS-FINAL", range =  "B4:I12") %>% 
    dplyr::select(Peg, EASTING, NORTHING, ELEVATION)
  
  
  saveRDS(KnownPegPositions, KnownPegPositions_binary_ffn)
  
  
}else{
  KnownPegPositions = readRDS(KnownPegPositions_binary_ffn)
}



known_loc= known_loc_P4



POS_ffn = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/Field-Test-Ballance-20231108/JVD/SOLUTIONS/OCC1-PPK-R10BASE/BALOCC1P6_BY_SCRIPT_csv.pos"

POS_ffn = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/Field-Test-Ballance-20231108/BAL_OCC1_JVD_RTKR10_FULL.pos"

POS_ffn = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/Field-Test-Ballance-20231108/BAL_OCC2_CAR_PPK_DNVK_FULL.pos"

POS_ffn = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/Field-Test-Ballance-20231108/BAL_OCC1_CAR_RTKR10_FULL.pos"

POS_ffn = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/Field-Test-Ballance-20231108/BAL_OCC1_CAR_RTKR10_FULL_FB.pos"

POS_ffn = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/Field-Test-Ballance-20231108/BAL_OCC1_CAR_RTKR10_30MIN.pos"

POS_ffn = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/Field-Test-Ballance-20231108/BAL_OCC1_CAR_RTKR10_05MIN.pos"

POS_ffn = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/Field-Test-Ballance-20231108/BAL_OCC1_CAR_RTKR10_FULL.pos"

POS_ffn = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/Field-Test-Ballance-20231108/BAL_OCC1_CAR_RTKR10_LAST_HOUR.pos"

POS_ffn = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/Field-Test-Ballance-20231108/BAL_OCC1_CAR_RTKR10_60MIN.pos"

POS_ffn = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/Field-Test-Ballance-20231108/BAL_OCC1_CAR_RTKR10_120MIN.pos"


POS_ffn = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/Field-Test-Ballance-20231108/BAL_OCC1_JVD_RTKR10_FULL.pos"

analyze_POS("JVD", OCC=1, PEG=6, PERIOD="240 MIN", POS_ffn )

POS_ffn = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/Field-Test-Ballance-20231108/BAL_OCC1_JVD_RTKR10_5MIN.pos"

analyze_POS("JVD", OCC=1, PEG=6, PERIOD="5 MIN", POS_ffn )

POS_ffn = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/Field-Test-Ballance-20231108/BAL_OCC1_JVD_RTKR10_10MIN.pos"

analyze_POS("JVD", OCC=1, PEG=6, PERIOD="10 MIN", POS_ffn )

POS_ffn = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/Field-Test-Ballance-20231108/BAL_OCC1_JVD_RTKR10_30MIN.pos"

analyze_POS("JVD", OCC=1, PEG=6, PERIOD="30 MIN", POS_ffn )

POS_ffn = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/Field-Test-Ballance-20231108/BAL_OCC1_JVD_RTKR10_60MIN.pos"

analyze_POS("JVD", OCC=1, PEG=6, PERIOD="60 MIN", POS_ffn )

POS_ffn = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/Field-Test-Ballance-20231108/BAL_OCC1_JVD_RTKR10_120MIN.pos"

analyze_POS("JVD", OCC=1, PEG=6, PERIOD="120 MIN", POS_ffn )

POS_ffn = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/Field-Test-Ballance-20231108/BAL_OCC1_TOP_RTKR10_FULL.pos"

analyze_POS("TOP", OCC=1, PEG=5, PERIOD="240 MIN", POS_ffn, plotdim=18)


POS_ffn = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/Field-Test-Ballance-20231108/BAL_OCC2_TOP_RTKR10_FULL.pos"

analyze_POS("TOP", OCC=2, PEG=8, PERIOD="60 MIN", POS_ffn, plotdim=50 )

# POS_ffn = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/Field-Test-Ballance-20231108/balo3120.pos"
# 
# analyze_POS("TOP", OCC=2, PEG=8, PERIOD="60 MIN", POS_ffn, limax=T )


POS_ffn = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/Field-Test-Ballance-20231108/BAL_OCC1_R10ROVER_RTKR10_FULL.pos"

analyze_POS("R10-ROVER", OCC=1, PEG=8, PERIOD="240 MIN", POS_ffn, limax=T )

POS_ffn = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/Field-Test-Ballance-20231108/BAL_OCC1_R10ROVER_RTKR10_FULL.pos"

analyze_POS("R10-ROVER", OCC=1, PEG=8, PERIOD="240 MIN", POS_ffn, plotdim = 3, tm_win = c(120,180) )



POS_ffn = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/Field-Test-Ballance-20231108/BAL_OCC2_R10ROVER_RTKR10_FULL.pos"

analyze_POS("R10-ROVER", OCC=2, PEG=5, PERIOD="FULL", POS_ffn, limax=T, plotdim=9 )


POS_ffn = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/Field-Test-Ballance-20231108/JVD/SOLUTIONS/BALOCC1P6_v2.pos"
analyze_POS("JVD", OCC=1, PEG=6, PERIOD="FULL", POS_ffn, limax=T, plotdim=9 )





POS_ffn = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/Field-Test-Ballance-20231108/SDL_004.obs"

analyze_POS("R10-ROVER", OCC=1, PEG=8, PERIOD="240 MIN", POS_ffn, plotdim = 3, tm_win = c(120,180) )






```


# issue a rnx2rtkp command

```{r}

cmd = "wsl rnx2rtkp -o BAL_OCC1_CAR_RTKR10_FULL_FB.pos -p 3 -f 3 -s ',' -c CAR/BAL-CAR-OCC1-P4-RINEX/BAL_OCC1_P4.23o R10-Base/RINEX211/01393111.23o R10-Base/RINEX211/01393111.23n"

datadir = "/mnt/c/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/Field-Test-Ballance-20231108/"

rover_fn = "CAR/BAL-CAR-OCC1-P4-RINEX/BAL_OCC1_P4.23o"
rover_ffn = paste0(datadir, rover_fn)

base_obs_fn = "R10-Base/RINEX211/01393111.23o"
base_obs_ffn = paste0(datadir, base_obs_fn)

base_nav_fn = "R10-Base/RINEX211/01393111.23n"
base_nav_ffn = paste0(datadir, base_nav_fn)




cmd = paste0("wsl rnx2rtkp -o BAL_OCC1_CAR_RTKR10_10MIN_from_R.pos -p 3 -f 3 -s \",\" -c ", "2023/11/7 21:25:12 -te 2023/11/7 21:35:12 ", "\"", rover_ffn, "\"", " ", "\"", base_obs_ffn, "\"", " ", "\"", base_nav_ffn, "\"")

print(cmd)


cmd = paste0("wsl ls ", "\"", datadir, "\"")



print(cmd)

system(cmd)



```


# running proc_rtk

```{r}


proc_rtk(Rover = "CAR", Occ = 1, Method = "RTK-R10", Period = "5MIN_TO_10MIN")


proc_rtk(Rover = "CAR", Occ = 1, Method = "RTK-CORS", Period = "FULL")
proc_rtk(Rover = "CAR", Occ = 1, Method = "RTK-CORS", Period = "30MIN")

proc_rtk(Rover = "CAR", Occ = 1, Method = "RTK-R10", Period = "60MIN")
proc_rtk(Rover = "EML", Occ = 1, Method = "RTK-R10", Period = "60MIN")
proc_rtk(Rover = "JVD", Occ = 1, Method = "RTK-R10", Period = "60MIN")
proc_rtk(Rover = "R10-Rover", Occ = 1, Method = "RTK-R10", Period = "60MIN")
proc_rtk(Rover = "TOP", Occ = 1, Method = "RTK-R10", Period = "60MIN")


proc_rtk(Rover = "CAR", Occ = 2, Method = "RTK-R10", Period = "60MIN")
proc_rtk(Rover = "EML", Occ = 2, Method = "RTK-R10", Period = "60MIN")
proc_rtk(Rover = "JVD", Occ =2, Method = "RTK-R10", Period = "60MIN")
proc_rtk(Rover = "R10-Rover", Occ = 2, Method = "RTK-R10", Period = "60MIN")
proc_rtk(Rover = "TOP", Occ = 2, Method = "RTK-R10", Period = "60MIN")

proc_rtk(Rover = "CAR", Occ = 1, Method = "RTK-CORS", Period = "60MIN")

rover_list = c("CAR","EML","JVD","R10-Rover", "TOP")
occ_list = c(1,2)
interval_list = c("5MIN","10MIN","30MIN","60MIN", "15MIN", "15MIN_TO_30MIN", "30MIN_TO_45MIN", "45MIN_TO_60MIN")

for (irover in rover_list){
  for (iocc in occ_list){
    for (iinterval in interval_list){
      proc_rtk(Rover =irover, Occ = iocc, Method = "RTK-R10", Period = iinterval, replot_only = T)
    }
  }
}

for (irover in rover_list){
  for (iocc in occ_list){
    # for (iinterval in interval_list){
    proc_rtk(Rover =irover, Occ = iocc, Method = "RTK-CORS", Period = "60MIN")
    # }
  }
}





# 
```




# Analyse JVD OCC1 in detail (first 60 minutes) using RTKPOST (GUI)

```{r}

POS_ffn = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/Field-Test-Ballance-20231108/JVD/SOLUTIONS/OCC1-PPK-R10BASE/SOLN_101.pos"

analyze_POS(RCVR="JVD", OCC = 2, PEG=4, PERIOD="60MIN", POS_ffn)



RTKLIB_RESULTS = proc_rtk(Rover = "JVD", Occ = 2, Method = "RTK-R10", Period = "240", plotdim = 3, replot_only = F)



POS_ffn = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/Field-Test-Ballance-20231108/JVD/SOLUTIONS/OCC1-PPK-R10BASE/SOLN_104.pos"






OUT = analyze_POS(RCVR="JVD", OCC = 1,METHOD = "RTK-R10", PEG=4, PERIOD="240MIN", POS_ffn = POS_ffn)

POS_ffn = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/Field-Test-Ballance-20231108/SOLUTIONS/BAL_OCC2_JVD_RTK-R10_60MIN.pos"


OUT = analyze_POS(RCVR="JVD", OCC = 2,METHOD = "RTK-R10", PEG=4, PERIOD="60MIN", POS_ffn = POS_ffn)

rtk_proc_anal(Rover="JVD", Occ=1, Method="RTK-R10", Period="", plotdim = 3, replot_only = F)

```


# Adhoc POS Analysis (especuially for those created by RTKLIB Gui)
```{r}

POS_ffn = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/Field-Test-Ballance-20231108/TOP/SOLUTIONS/bal-3110_v3.pos"


OUT = analyze_POS("TOP", OCC=2, PEG=8, METHOD = "RTK-R10", PERIOD="60MIN", POS_ffn, FMT_OPT = 2, qualfilt = NULL)






```


# Processing of R10-Base using Precise Emphemeris/Clock and DNVK CORS
```{r}

# POS_ffn = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/Field-Test-Ballance-20231108/TOP/SOLUTIONS/bal-3110_v3.pos"
# 
# 
# OUT = analyze_POS("TOP", OCC=2, PEG=8, METHOD = "RTK-R10", PERIOD="60MIN", POS_ffn, FMT_OPT = 2, qualfilt = NULL)

R10_Base_files2proc = list.files("C:\Users\McMillanAn\OneDrive - MWLR\Projects\PRJ3820-DOC-GNSS\data\Field-Test-Ballance-20231108\R10-Base\Bens-Rinex-Files")







```

#FORMAL RUNS FOR REPORT

```{r}


PERDS = c("240MIN", "180MIN", "120MIN", "60MIN", "45MIN", "30MIN" )
# PERDS = c("60MIN" )

RCVRS = c("JVD", "TOP", "CAR", "EML", "R10-Rover")
RCVRS = c("R10-Rover")
METHODS = c("RTK-R10", "RTK-CORS-DNVK", "RTK-CORS-WRPA")
# METHODS = c("RTK-CORS-DNVK")
OCCS = c(1,2)
OCCS = c(2)

for (iMETHOD in METHODS){
  for (iRCVR in RCVRS){
    for (iOCC in OCCS){
      if (iOCC==1){
        for (iPERD in PERDS){
          rtk_proc_anal(Rover=iRCVR, Occ=iOCC, Method=iMETHOD, Period=iPERD, plotdim = 3, replot_only = F)
        }
      }else{
        for (iPERD in PERDS[4:7]){
          rtk_proc_anal(Rover=iRCVR, Occ=iOCC, Method=iMETHOD, Period=iPERD, plotdim = 3, replot_only = F)
        }
      }
      
      
      
    }
  }
}






```

#Run analysis of collated data

```{r}
CollateDF_ffn =  "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/Field-Test-Ballance-20231108/SOLUTIONS/GNSS_PERFORMANCE_STATS_COLLATED.csv"

D = read_csv(CollateDF_ffn)
```


```{r}

D_240MIN = D %>% 
  filter(MIN_ELAPSED >200) 

g = ggplot(D_240MIN) + geom_point(aes(RCVR, M_ACC, color = METHOD  ), size  =3)
# g = g + geom_errorbar(aes(x = RCVR, ymin = M_ACC-M_PREC, ymax = M_ACC + M_PREC, color = METHOD), width = .2) + geom_jitter()
g = g + labs(x = "Receiver", y = "Accuracy (m)")
# g = g + lims(y = c(0,2))
g

ggsave(filename = paste0(plotdir, "1004-Accuracy-240MINOCC-BY-METHOD.png"), g)

```




# ~~~~~~~~~~~~~~~~ #
# Figure 2001 -  Accuracy-vs-Rcvr-by-Method
# ~~~~~~~~~~~~~~~~ #

```{r}

fignum = 2001
figdesc = "Accuracy-vs-Rcvr-by-Method"
figfmt = "png"
fig_ffn = paste0(plotdir, fignum,"-", figdesc, ".", figfmt)



D_240MIN = D %>% 
  filter(MIN_ELAPSED >200) 

g = ggplot(D_240MIN) + geom_point(aes(RCVR, M_ACC, color = METHOD  ), size  =3)
# g = g + geom_errorbar(aes(x = RCVR, ymin = M_ACC-M_PREC, ymax = M_ACC + M_PREC, color = METHOD), width = .2) + geom_jitter()
g = g + labs(x = "Receiver", y = "Accuracy (m)")
# g = g + lims(y = c(0,2))
g

ggsave(filename = fig_ffn, plot = g, width = 28, height = 16, units = "cm", bg = "white")


```


# ~~~~~~~~~~~~~~~~ #
# Figure 2002 -  Accuracy-vs-Rcvr-by-Method-180min
# ~~~~~~~~~~~~~~~~ #

```{r}

fignum = 2002
figdesc = "Accuracy-vs-Rcvr-by-Method-180min"
figfmt = "png"
fig_ffn = paste0(plotdir, fignum,"-", figdesc, ".", figfmt)



D_SEL = D %>% 
  filter(MIN_ELAPSED >140 & MIN_ELAPSED <200) 

g = ggplot(D_SEL) + geom_point(aes(RCVR, M_ACC, color = METHOD  ), size  =3)
# g = g + geom_errorbar(aes(x = RCVR, ymin = M_ACC-M_PREC, ymax = M_ACC + M_PREC, color = METHOD), width = .2) + geom_jitter()
g = g + labs(x = "Receiver", y = "Accuracy (m)")
g = g + lims(y = c(0,2))
g

ggsave(filename = fig_ffn, plot = g, width = 28, height = 16, units = "cm", bg = "white")


```


# check

```{r}

ffn = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/Field-Test-Ballance-20231108/SOLUTIONS/BAL_OCC1_R10-Rover_RTK-R10_180MIN.pos"

known_coords = c(1838917.665,	5531119.762)

D = read_POS(ffn) %>% 
  st_as_sf(coords = c("Lon_DD","Lat_DD"), crs = "EPSG:4326") %>% 
  st_transform(crs = 2193) 

COORDS = st_coordinates(D) %>% 
  as_tibble() %>% 
  mutate(
    X_dev = X-mean(X),
    Y_dev = Y-mean(Y),
    X_filt_1sd = ifelse(abs(X_dev) > sd(X), NA, X),
    Y_filt_1sd = ifelse(abs(Y_dev) > sd(Y), NA, Y),
    X_filt_2sd = ifelse(abs(X_dev) > 2*sd(X), NA, X),
    Y_filt_2sd = ifelse(abs(Y_dev) > 2*sd(Y), NA, Y),
    X_filt_3sd = ifelse(abs(X_dev) > 3*sd(X), NA, X),
    Y_filt_3sd = ifelse(abs(Y_dev) > 3*sd(Y), NA, Y),
    X_filt_6sd = ifelse(abs(X_dev) > 6*sd(X), NA, X),
    Y_filt_6sd = ifelse(abs(Y_dev) > 6*sd(Y), NA, Y)
  )



COORDS_SMY = COORDS %>% 
  summarise(
    Xmean = mean(X),
    Ymean = mean(Y),
    X_filt_1sd_mean = mean(X_filt_1sd, na.rm = T),
    Y_filt_1sd_mean = mean(Y_filt_1sd, na.rm = T),
    X_filt_2sd_mean = mean(X_filt_2sd, na.rm = T),
    Y_filt_2sd_mean = mean(Y_filt_2sd, na.rm = T),
    X_filt_3sd_mean = mean(X_filt_3sd, na.rm = T),
    Y_filt_3sd_mean = mean(Y_filt_3sd, na.rm = T),
    X_filt_6sd_mean = mean(X_filt_6sd, na.rm = T),
    Y_filt_6sd_mean = mean(Y_filt_6sd, na.rm = T),
    Xmedian = median(X),
    Ymedian = median(Y),
    X_filt_1sd_median = median(X_filt_1sd, na.rm = T),
    Y_filt_1sd_median = median(Y_filt_1sd, na.rm = T),
    X_filt_2sd_median = median(X_filt_2sd, na.rm = T),
    Y_filt_2sd_median = median(Y_filt_2sd, na.rm = T),
    X_filt_3sd_median = median(X_filt_3sd, na.rm = T),
    Y_filt_3sd_median = median(Y_filt_3sd, na.rm = T),
    X_filt_6sd_median = median(X_filt_6sd, na.rm = T),
    Y_filt_6sd_median = median(Y_filt_6sd, na.rm = T),
    
    
  ) %>% 
  mutate(
    
    ACC_no_filt = sqrt( (known_coords[1] - Xmean)^2 + (known_coords[2] - Ymean)^2),
    ACC_1sd_filt = sqrt( (known_coords[1] - X_filt_1sd_mean)^2 + (known_coords[2] - Y_filt_1sd_mean)^2),
    ACC_2sd_filt = sqrt( (known_coords[1] - X_filt_2sd_mean)^2 + (known_coords[2] - Y_filt_2sd_mean)^2),
    ACC_3sd_filt = sqrt( (known_coords[1] - X_filt_3sd_mean)^2 + (known_coords[2] - Y_filt_3sd_mean)^2),
    ACC_6sd_filt = sqrt( (known_coords[1] - X_filt_6sd_mean)^2 + (known_coords[2] - Y_filt_6sd_mean)^2),
    ACC_MEDIAN_no_filt = sqrt( (known_coords[1] - Xmedian)^2 + (known_coords[2] - Ymedian)^2),
    ACC_MEDIAN_1sd_filt = sqrt( (known_coords[1] - X_filt_1sd_median)^2 + (known_coords[2] - Y_filt_1sd_median)^2),
    ACC_MEDIAN_2sd_filt = sqrt( (known_coords[1] - X_filt_2sd_median)^2 + (known_coords[2] - Y_filt_2sd_median)^2),
    ACC_MEDIAN_3sd_filt = sqrt( (known_coords[1] - X_filt_3sd_median)^2 + (known_coords[2] - Y_filt_3sd_median)^2),
    ACC_MEDIAN_6sd_filt = sqrt( (known_coords[1] - X_filt_6sd_median)^2 + (known_coords[2] - Y_filt_6sd_median)^2)
    
    
    
  )

print(COORDS_SMY %>% select(contains("ACC"))) %>% t

D_smy = D %>% summarise(
  
  LAT = mean(Lat_DD), 
  LON = mean(Lon_DD),
  LAT_sd = sd(Lat_DD),
  LON_sd = sd(Lon_DD),
)

D = 
  
  sf = D_smy 

sf_2193 = sf %>% st_transform(crs = 2193)
mapview(sf_2193)

sf_2193_coords = st_coordinates(sf_2193)


del_X = sf_2193_coords[1] - known_coords[1]
del_Y = sf_2193_coords[2] - known_coords[2]

ACC = sqrt(del_X^2 + del_X^2)



```

# RTKLIB on R10-Base

```{r}

R10_Base_Rinex_files = list.files("C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/Field-Test-Ballance-20231108/R10-Base/Bens-Rinex-Files/", full.names = T)


InputFile_01393111_ffn = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/proc_rtk_generic_filelists/RTKLIB-inputfilelist-R10-Base-01393111.txt"



InputFile_01393120_ffn = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/proc_rtk_generic_filelists/RTKLIB-inputfilelist-R10-Base-01393120.txt"


InputFile_01393180_ffn = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/proc_rtk_generic_filelists/RTKLIB-inputfilelist-R10-Base-01393180.txt"


SOLN_01393111 = SOLN_ANL_generic(InputFile_01393111_ffn)
SOLN_01393120 = SOLN_ANL_generic(InputFile_01393120_ffn)
SOLN_01393180 = SOLN_ANL_generic(InputFile_01393180_ffn)


SOLN_ANL_generic = function(InputFile_ffn){
  
  # InputFile_ffn = InputFile_01393111_ffn
  # POS_SOLN_3111 = proc_rtk_generic(InputFile_ffn = InputFile_01393111_ffn)
  # POS_SOLN_3120 = proc_rtk_generic(InputFile_ffn = InputFile_01393120_ffn)
  # 
  # POS_SOLN_ANL = NA
  # POS_SOLN_ANL_3111 = anal_POS_generic(POS_SOLN_3111$POS_ffn, known_coords = c(1839374.859,	5531494.916))
  # POS_SOLN_ANL_3120 = anal_POS_generic(POS_SOLN_3120$POS_ffn, known_coords = c(1839374.859,	5531494.916))
  POS_SOLN = proc_rtk_generic(InputFile_ffn = InputFile_ffn)
  
  SOLUTION_ffn = POS_SOLN$POS_ffn
  POS_SOLN_ANL = anal_POS_generic(SOLUTION_ffn, known_coords = c(1839374.859,	5531494.916))
  
  
  
  # now collate all the files
  
  SOLUTION_fn = tools::file_path_sans_ext(SOLUTION_ffn)
  SOLUTION_SMY_dn = paste0(dirname(dirname(SOLUTION_fn)),"/SOLUTION_SMY/")
  SOLUTION_SMY_ffn = paste0(SOLUTION_SMY_dn,basename(SOLUTION_fn),"_SMY.txt") 
  
  write_csv(as.data.frame(t(POS_SOLN_ANL)),file=SOLUTION_SMY_ffn )
  
  print(paste("Writing summary of results to",SOLUTION_SMY_ffn ))
  
  SMY_fls = list.files(SOLUTION_SMY_dn,pattern = "\\.txt$", full.names = T)
  for (i in SMY_fls){
    D = read_csv(i) %>% 
      mutate(filename = basename(i)) %>% 
      select(filename, everything())
    if (i == SMY_fls[1]){
      DD = D
    }else{
      DD = DD %>% 
        bind_rows(D) 
    }
  }
  SOLUTION_SMY_COLLATED = DD 
  
  
  SOLUTION_SMY_COLLATED_ffn = paste0(SOLUTION_SMY_dn, "SOLUTION_SMY_COLLATED.csv")
  write_csv(SOLUTION_SMY_COLLATED,SOLUTION_SMY_COLLATED_ffn)
  
  
  
  
  return(POS_SOLN_ANL)
  
  
  
  
  
}


```


```{r}

POS_ffn = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/Field-Test-Ballance-20231108/R10-Base/SOLUTIONS/01393111.pos"

POS_ffn = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/Field-Test-Ballance-20231108/R10-Base/SOLUTIONS/Rinex_304_Occ1.pos"

POS_ffn = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/Field-Test-Ballance-20231108/TestDir/Solution.pos"

POS_ffn = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/Field-Test-Ballance-20231108/R10-Base/InputFiles_01393111/Solution.pos"

# Using the CLI (rns2rtkp.exe)
POS_ffn = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/Field-Test-Ballance-20231108/R10-Base/InputFiles_01393120/Solution-01.pos"


X = anal_POS_generic(POS_ffn = POS_ffn)

# Using the GUI (RTKPOST.exe)
POS_ffn = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/Field-Test-Ballance-20231108/R10-Base/InputFiles_01393120/solution-GUI-01.pos"

X = anal_POS_generic(POS_ffn = POS_ffn)

# Using the GUI (RTKPOST.exe)
# fix and hold on GPS
POS_ffn = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/Field-Test-Ballance-20231108/R10-Base/InputFiles_01393120/solution-GUI-02.pos"

X = anal_POS_generic(POS_ffn = POS_ffn)

#=======================================================
#  Test 03 - Change Threshold for Integer Ambiguity to 1.5 (from 3)
#======================================================

# Using the GUI (RTKPOST.exe)
# fix and hold on GPS
POS_ffn = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/Field-Test-Ballance-20231108/R10-Base/InputFiles_01393120/solution-GUI-03.pos"

X = anal_POS_generic(POS_ffn = POS_ffn)

#=======================================================
#  Test 04 - Do not inlcude precise ephem and clock (use broadcast isntead)
#======================================================

# Using the GUI (RTKPOST.exe)
# 
POS_ffn_curr = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/Field-Test-Ballance-20231108/R10-Base/InputFiles_01393120/solution-GUI-04.pos"

X = anal_POS_generic(POS_ffn = POS_ffn_curr)

# --> this only made a tiny difference

#=======================================================
#  Test 05 - Forward (not combined)
#======================================================

# Using the GUI (RTKPOST.exe)
# Use forward solution only

POS_ffn = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/Field-Test-Ballance-20231108/R10-Base/InputFiles_01393120/solution-GUI-05.pos"

X = anal_POS_generic(POS_ffn = POS_ffn)

# --> Significant improvement in accuracy, precision not as good. But shorter processing

#=======================================================
#  Test 06 - Use interpolated Base Station data
#======================================================

# Using the GUI (RTKPOST.exe)
# Use forward solution only

POS_ffn = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/Field-Test-Ballance-20231108/R10-Base/InputFiles_01393120/solution-GUI-06.pos"

X = anal_POS_generic(POS_ffn = POS_ffn)

# --> Makes big difference. Still no fixed!


#=======================================================
#  Swith to day 319
#======================================================

# Using the GUI (RTKPOST.exe)
# Use forward solution only

POS_ffn = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/Field-Test-Ballance-20231108/R10-Base/InputFiles_01393190/01393192.pos"

X = anal_POS_generic(POS_ffn = POS_ffn)

# --> Makes big difference. Still no fixed!



#=======================================================
#  Swith to day 298
#======================================================

# Using the GUI (RTKPOST.exe)
# Use forward solution only

POS_ffn = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/Field-Test-Ballance-20231108/R10-Base/InputFiles_01392982/01392982_v2.pos"

X = anal_POS_generic(POS_ffn = POS_ffn)

# --> Makes big difference. Still no fixed!



#=======================================================
#  Swith to day 298 Change AR ratio th/h to 1
#======================================================

# Using the GUI (RTKPOST.exe)
# Use forward solution only

POS_ffn = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/Field-Test-Ballance-20231108/R10-Base/InputFiles_01392982/01392982_v3.pos"

X = anal_POS_generic(POS_ffn = POS_ffn)

# --> Makes big difference. Still no fixed!


#=======================================================
#  Swith to day 298 Change AR ratio th/h to 2
#======================================================

# Using the GUI (RTKPOST.exe)
# Use forward solution only

POS_ffn = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/Field-Test-Ballance-20231108/R10-Base/InputFiles_01392982/01392982_v4.pos"

X = anal_POS_generic(POS_ffn = POS_ffn)

# --> M

#=======================================================
#  Swith to day 298 Change AR ratio th/h to 1.5
#======================================================

# Using the GUI (RTKPOST.exe)
# Use forward solution only

POS_ffn = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/Field-Test-Ballance-20231108/R10-Base/InputFiles_01392982/01392982_v5.pos"

X = anal_POS_generic(POS_ffn = POS_ffn)

# --> ...

#=======================================================
#  Swith to day 298 Change AR ratio th/h to 1.5 / no precise eph/clk
#======================================================

# Using the GUI (RTKPOST.exe)
# Use forward solution only

POS_ffn = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/Field-Test-Ballance-20231108/R10-Base/InputFiles_01392982/01392982.pos"

X = anal_POS_generic(POS_ffn = POS_ffn)

#=======================================================
# v9 Day 298 Change AR ratio th/h to 1.5 / no precise eph/clk / wrpa as base
#======================================================

# Using the GUI (RTKPOST.exe)
# Use forward solution only

POS_ffn = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/Field-Test-Ballance-20231108/R10-Base/InputFiles_01392982/01392982_v9.pos"

X = anal_POS_generic(POS_ffn = POS_ffn)

#=======================================================
# v10 Day 298 Change AR ratio th/h to 1.5 / WITH precise eph/clk / wrpa as base
#======================================================

# Using the GUI (RTKPOST.exe)
# Use forward solution only

POS_ffn = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/Field-Test-Ballance-20231108/R10-Base/InputFiles_01392982/01392982_v10.pos"

X = anal_POS_generic(POS_ffn = POS_ffn)

#=======================================================
# v11 Day 298 Change Base back to DNVK, AR ratio th/h to 1.5 / WITH precise eph/clk / dnvk as base
#======================================================

# Using the GUI (RTKPOST.exe)


POS_ffn = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/Field-Test-Ballance-20231108/R10-Base/InputFiles_01392982/01392982_v11.pos"

X = anal_POS_generic(POS_ffn = POS_ffn)


#=======================================================
# v12 Day 298 Change the Ionospheric correction from "IONEX TEC" to "ESTIMATE TEC", AR ratio th/h to 1.5 / WITH precise eph/clk / dnvk as base
#======================================================

# Using the GUI (RTKPOST.exe)


POS_ffn = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/Field-Test-Ballance-20231108/R10-Base/InputFiles_01392982/01392982_v12.pos"

X = anal_POS_generic(POS_ffn = POS_ffn)


# --> ...

#=======================================================
# v13 Day 298 Change the Ionospheric correction from "IONEX TEC" to "IONO-FREE LC", AR ratio th/h to 1.5 / WITH precise eph/clk / dnvk as base
#======================================================

# Using the GUI (RTKPOST.exe)


POS_ffn = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/Field-Test-Ballance-20231108/R10-Base/InputFiles_01392982/01392982_v13.pos"

X = anal_POS_generic(POS_ffn = POS_ffn)


#=======================================================
# v14 Day 298 Increate the AR from 1.5 to 3.0 Change the Ionospheric correction from "IONEX TEC" to "IONO-FREE LC", AR ratio th/h to 1.5 / WITH precise eph/clk / dnvk as base
#======================================================

# Using the GUI (RTKPOST.exe)


POS_ffn = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/Field-Test-Ballance-20231108/R10-Base/InputFiles_01392982/01392982_v14.pos"

X = anal_POS_generic(POS_ffn = POS_ffn)


# --> ...

#=======================================================
# v15 Day 298 Ionospheric Correction OFF Increate the AR from 1.5 to 3.0 AR ratio th/h to 1.5 / WITH precise eph/clk / dnvk as base
#======================================================

# Using the GUI (RTKPOST.exe)


POS_ffn = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/Field-Test-Ballance-20231108/R10-Base/InputFiles_01392982/01392982_v15.pos"

X = anal_POS_generic(POS_ffn = POS_ffn)


# --> ...

#=======================================================
# v16 Day 298 Enable RAIM FDE Option, Ionospheric Correction OFF Increate the AR from 1.5 to 3.0 AR ratio th/h to 1.5 / WITH precise eph/clk / dnvk as base
#======================================================

# Using the GUI (RTKPOST.exe)


POS_ffn = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/Field-Test-Ballance-20231108/R10-Base/InputFiles_01392982/01392982_v16.pos"

X = anal_POS_generic(POS_ffn = POS_ffn, known_coords = c(1838917.665,	5531119.762))


# --> ...makes no difference

#=======================================================
# v16 Day 311 Ionospheric Correction OFF Increate the AR from 1.5 to 3.0 AR ratio th/h to 1.5 / WITH precise eph/clk / dnvk as base
#======================================================

# Using the GUI (RTKPOST.exe)


POS_ffn = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/Field-Test-Ballance-20231108/R10-Base/InputFiles_01393111/01393111_v16.pos"



POS_ffn = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/Field-Test-Ballance-20231108/R10-Rover/SOLUTIONS/RTK-LIB/R10-Rover-PPK-R10-Base_v04.pos"

X = anal_POS_generic(POS_ffn = POS_ffn, known_coords = c(1838917.665,	5531119.762))


POS_ffn = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/Field-Test-Ballance-20231108/JVD/SOLUTIONS/OCC1-PPK-R10BASE/SOL_105.pos"

X = anal_POS_generic(POS_ffn = POS_ffn, known_coords = c(1838912.997,	5531118.343))



POS_ffn = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/Field-Test-Ballance-20231108/JVD/SOLUTIONS/Demo5-RTKLIB/SOLN-JVD-OCC1-v01"

X = anal_POS_generic(POS_ffn = POS_ffn, known_coords = c(1838912.997,	5531118.343))





# --> ...makes no difference
```



#Systematic Tests with JVD OCC1 19/12/23
```{r}

#=======================================================
# Run 1 - JVD-OCC1-Config-v01.conf
#======================================================


POS_ffn = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/Field-Test-Ballance-20231108/JVD/SOLUTIONS/JVD-OCC1-SOLN-v01.POS"

X = anal_POS_generic(POS_ffn = POS_ffn, known_coords = c(1838912.997,	5531118.343))


#=======================================================
# Run 1 - JVD-OCC1-Config-v02.conf - no base interp
#======================================================


POS_ffn = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/Field-Test-Ballance-20231108/JVD/SOLUTIONS/JVD-OCC1-SOLN-v08.POS"

X = anal_POS_generic(POS_ffn = POS_ffn, known_coords = c(1838912.997,	5531118.343))


# =======================================================
# Run 1 - JVD-OCC1-Config-v02.conf - no base interp
#======================================================


POS_ffn = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/Field-Test-Ballance-20231108/JVD/SOLUTIONS/JVD-OCC2-SOLN-v07.POS"

X = anal_POS_generic(POS_ffn = POS_ffn, known_coords = c(1838906.513,	5531123.153))


# =======================================================
# Run 1 - JVD-OCC1-Config-v02.conf - no base interp
#======================================================

POS_ffn = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/Field-Test-Ballance-20231108/CAR/SOLUTIONS/CAR-OCC1-SOLN-v01.POS"


X = anal_POS_generic(POS_ffn = POS_ffn, known_coords = c(1838906.513,	5531123.153))

# X = anal_POS_generic(POS_ffn = POS_ffn, known_coords = c(1838921.146,	5531125.433))


POS_ffn = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/Field-Test-Ballance-20231108/JVD/RTKCONV/BALOCC1P6_v2.pos"


X = anal_POS_generic(POS_ffn = POS_ffn, known_coords = c(1838912.997,	5531118.343))

# X = anal_POS_generic(POS_ffn = POS_ffn, known_coords = c(1838921.146,	5531125.433))



```




PPP conversions

```{r}

PPP_Coords_R10_Base_01392982 = data.frame(X = 399581.897, Y = 5534636.524) %>% 
  st_as_sf(coords = c("X","Y"), crs = 32760) %>% 
  st_transform(crs = 2193) %>% 
  st_coordinates() 




print(formatC(PPP_Coords_R10_Base_01392982, digits = 12))






```

# Mess around with three D coordinate transformations


```{r}




R10BASE_9528 = st_as_sf(data.frame(X = 1839374.859	, Y = 5531494.916, Z = 	79.451), coords = c("X","Y", "Z"), crs = 9528)
R10BASE_2193 = st_transform(R10BASE_9528, crs = 2193)


X_DMS = c(175, 48, 45.27946)
Y_DMS = c(-40, 20, 10.51917)

Z = 25.111

X_DD = sign(X_DMS[1])*(abs(X_DMS[1]) + X_DMS[2]/60 + X_DMS[3]/3600)
Y_DD = sign(Y_DMS[1])*(abs(Y_DMS[1]) + Y_DMS[2]/60 + Y_DMS[3]/3600)

remove(POSN_DF)

POSN_DF = data.frame(X = X_DD, Y = Y_DD, Z = Z)

POSN_SF = st_as_sf(POSN_DF, coords = c("X","Y", "Z"), crs = 4326)

mapview(POSN_SF)

POSN_SF_2193 = POSN_SF %>% st_transform(crs = 2193)


NZQG_ffn= "C:/Users/McMillanAn/OneDrive - MWLR/NZ-Geospatial-Data/lds-nz-quasigeoid-2016-raster-GTiff/new_zealand_quasigeoid_2016_raster.tif"
NZQG = rast(NZQG_ffn)

QG_pts = terra::extract(NZQG, POSN_SF) %>% as.numeric() %>% nth(2)

Adjusted_ELEV = POSN_SF_2193 %>% st_coordinates() %>% as_tibble() %>% select("Z") - QG_pts

POSN_SF_2193_XY = POSN_SF_2193 %>% st_coordinates()%>% as_tibble() %>% select(X,Y)

POSN_DF_2193_NZVD16 = POSN_SF_2193_XY %>% mutate(Adjusted_ELEV)
POSN_SF_2193_NZVD16 = st_as_sf(POSN_DF_2193_NZVD16, coords = c("X","Y", "Z"), crs = 9528)



```



# Mess around with epochs and realisaztions

# EPSG:9988     ITRF2020      Cartesian/Geocentric     Ellipsoid: GRS 1980
# EPSG:9990     ITRF2020      Geodetic  (degrees)      Ellipsoid: GRS 1980

# EPSG:7789     ITRF2014      Cartesian/Geocentric     Ellipsoid: GRS 1980
# EPSG:7912     ITRF2014      Geodetic                 Ellipsoid: GRS 1980

# EPSG:32760    UTM Zone 60S  Geodetic                 Ellipsoid: GRS 1980

# EPSG:2193     NZMG2000      Geodetic                 Ellipsoid: GRS 1980
# EPSG:9528    NZGD2000 + NZVD2016 height,Geodetic     Ellipsoid: NZVD2016 (EPSG:7839)


```{r}

# The CSRS PPP value for the Bridge R10-Base Station is :
XYZ_ITRF14_ep2010p0_RTX =data.frame(X=-4855980.940, Y=355080.488, Z=-4106283.629)

# create a SF object using the ITRF2014 (Epoch 2010.0) Geocentric Coord System 
XYZ_ITRF14_ep2010p0_RTX_sf = st_as_sf(XYZ_ITRF14_ep2010p0_RTX, coords = c("X","Y","Z"), crs = 7789)

#transform these coordinates to the Geodetic Coordinate System 
XYZ_ITRF14_ep2010p0_RTX_sf_7912 = XYZ_ITRF14_ep2010p0_RTX_sf %>% 
  st_transform(7912)

#transform to 2193
XYZ_ITRF14_ep2010p0_RTX_sf_2193 = XYZ_ITRF14_ep2010p0_RTX_sf_7912 %>% 
  st_transform(2193)

# ABOVE DOESN'T WORK WE GET THIS ERROR:

# Warning messages:
# 1: In CPL_transform(x, crs, aoi, pipeline, reverse, desired_accuracy,  :
#   GDAL Error 1: PROJ: defmodel: Cannot open nz_linz_nzgd2000-20180701.json
# 2: In CPL_transform(x, crs, aoi, pipeline, reverse, desired_accuracy,  :
#   GDAL Error 1: PROJ: pipeline: Pipeline: Bad step definition: inv (File not found or invalid)

#transform to 2193
XYZ_ITRF14_ep2010p0_RTX_sf_2193 = XYZ_ITRF14_ep2010p0_RTX_sf %>% 
  st_transform(4326) %>% 
  st_transform(2193) %>% 
  st_coordinates()

formatC(XYZ_ITRF14_ep2010p0_RTX_sf_2193, digits = 11)





XYZ_ITRF14_ep2010p0_RTX_sf_7912_coords = XYZ_ITRF14_ep2010p0_RTX_sf_7912 %>% st_coordinates()

print(formatC(XYZ_ITRF14_ep2010p0_RTX_sf_7912_coords, digits = 12))


XYZ_ITRF14_ep2010p0_RTX_sf_7912_coords_X_DMS = DD2DMS(XYZ_ITRF14_ep2010p0_RTX_sf_7912_coords[1])
XYZ_ITRF14_ep2010p0_RTX_sf_7912_coords_Y_DMS = DD2DMS(XYZ_ITRF14_ep2010p0_RTX_sf_7912_coords[2])

XYZ_ITRF14_ep2010p0_RTX_sf_7912_coords


CSRS_PPP_XY = data.frame(X = 399581.927, Y=5534636.546)
CSRS_PPP_XY_SF = CSRS_PPP_XY %>% 
  st_as_sf(coords = c("X","Y"), crs = 32760) %>% 
  st_transform(crs = 2193)

print(formatC(as.numeric(st_coordinates(CSRS_PPP_XY_SF)), digits=11))

DD2DMS = function(DD){
  # DD = -38.82573703
  DD_whole = sign(DD) *floor(abs(DD))
  DD_dec = abs(DD) %% 1
  DD_min_float = DD_dec * 60
  DD_min_whole = floor(DD_min_float)
  DD_min_frac = DD_min_float %% 1
  DD_sec = DD_min_frac*60
  DMS = c(DD_whole, DD_min_whole, DD_sec)
}



```

#=======================================================
# Test RTK Settings using results from Ballance Field Test 20/12/23
#=======================================================

## 1. JVD-OCC3-P7 v01 Analyse the V01 Solution for 12 hour occupation for the JAVAD ---

```{r}



POS_ffn = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/Field-Test-Ballance-20231220/JVD/OCC3-P7/SOLUTIONS/JVD-OCC3-P7-PPK-DNVK.POS"
X = anal_POS_generic(POS_ffn = POS_ffn, known_coords = c(1838921.184,	5531125.402))

```

## 2. JVD-OCC3-P7 v02 Use preceise eph and clock ---

```{r}



POS_ffn = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/Field-Test-Ballance-20231220/JVD/OCC3-P7/SOLUTIONS/JVD-OCC3-P7-PPK-DNVK_v02.POS"

X = anal_POS_generic(POS_ffn = POS_ffn, known_coords = c(1838921.184,	5531125.402))

```

## 3. JVD-OCC3-P7 v03 increas elev mask to 30 degrees ---

```{r}



POS_ffn = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/Field-Test-Ballance-20231220/JVD/OCC3-P7/SOLUTIONS/JVD-OCC3-P7-PPK-DNVK_v03.POS"

X = anal_POS_generic(POS_ffn = POS_ffn, known_coords = c(1838921.184,	5531125.402))

```

## 4. JVD-OCC3-P7 v04 Uncheck Gallileo and BDS

```{r}



POS_ffn = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/Field-Test-Ballance-20231220/JVD/OCC3-P7/SOLUTIONS/JVD-OCC3-P7-PPK-DNVK_v04.POS"

X = anal_POS_generic(POS_ffn = POS_ffn, known_coords = c(1838921.184,	5531125.402))

```


## 5. JVD-OCC6-P3 v00 

```{r}



POS_ffn = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/Field-Test-Ballance-20231220/JVD/OCC6-P3/SOLUTIONS/JVD-OCC6-P3-PPK-DNVK.POS"

X = anal_POS_generic(POS_ffn = POS_ffn, known_coords = c(1838911.099,	5531126.121))

```

# 6. JVD-OCC7-P2 v00 

```{r}



POS_ffn = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/Field-Test-Ballance-20231220/JVD/OCC7-P2/SOLUTIONS/JVD-OCC7-P2-PPK-DNVK.POS"

X = anal_POS_generic(POS_ffn = POS_ffn, known_coords = c(1838904.908,	5531130.900))

```

## 7. JVD-OCC3-P7 v01 Analyse the V00 Solution for 12 hour occupation for the JAVAD with a Age setting of 10 sec (prev 30 sec)---

```{r}



POS_ffn = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/Field-Test-Ballance-20231220/JVD/OCC3-P7/SOLUTIONS/JVD-OCC3-P7-PPK-DNVK.POS"
X = anal_POS_generic(POS_ffn = POS_ffn, known_coords = c(1838921.146,	5531125.433))

# [1] "LAT =  5531125.5954"
# [1] "LON =   1838921.034"
# [1] "ELEV =  122.015"
# [1] "ACCURACY +/- PREC (ALL)            =  0.1973  +/-  0.6524 m"
# [1] "ACCURACY +/- PREC (FLOAT)          =  0.1772  +/-  0.05766 m"
# [1] "ACCURACY +/- PREC (FIXED)          =  0.3217  +/-  1.424 m"
# [1] "ACCURACY +/- PREC (FIXED or FLOAT) =  0.1973  +/-  0.6524 m"
# [1] "PREC =  0.6524"
# [1] "PERCENT FIXED =  20.57 %"
# [1] "PERCENT FLOAT =  79.43 %"
# [1] " 1838921.034 5531125.5954 122.015 0.1973 0.6524 0.1772 0.05766"

```

## 8. JVD-OCC5-P5 ---

```{r}

POS_ffn = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/Field-Test-Ballance-20231220/JVD/OCC5-P5/SOLUTIONS/JVD-OCC5-P5-PPK-DNVK.POS"
X = anal_POS_generic(POS_ffn = POS_ffn, known_coords = get_peg_loc(5))


```

#=======================================================
# Formally Analyse data using PPK_CORS_DEFAULT.conf (PPK_CORS_v05.conf) on all data from 20/12/23
#=======================================================

1. Method PPK_CORS

## 1. R10-ROVER-OCC3-P1 ---

```{r}

POS_ffn = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/Field-Test-Ballance-20231220/R10-ROVER/OCC3-P1/SOLUTIONS/R10-ROVER-OCC3-P1-PPK-DNVK.POS"
X = anal_POS_generic(POS_ffn = POS_ffn, known_coords = get_peg_loc(1))


```

## 2. R10-ROVER-OCC5-P4 ---

```{r}

POS_ffn = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/Field-Test-Ballance-20231220/R10-ROVER/OCC5-P4/SOLUTIONS/R10-ROVER-OCC5-P4-PPK-DNVK.POS"
X = anal_POS_generic(POS_ffn = POS_ffn, known_coords = get_peg_loc(4))


```

## 3. R10-ROVER-OCC6-P7 ---

```{r}

POS_ffn = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/Field-Test-Ballance-20231220/R10-ROVER/OCC6-P7/SOLUTIONS/R10-ROVER-OCC6-P7-PPK-DNVK.POS"
X = anal_POS_generic(POS_ffn = POS_ffn, known_coords = get_peg_loc(7))


```

## 4. R10-ROVER-OCC7-P3 ---

```{r}

POS_ffn = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/Field-Test-Ballance-20231220/R10-ROVER/OCC7-P3/SOLUTIONS/R10-ROVER-OCC7-P3-PPK-DNVK.POS"
X = anal_POS_generic(POS_ffn = POS_ffn, known_coords = get_peg_loc(3))


```

## 5. R10-ROVER-OCC8-PX-PPK-DNVK ---

```{r}

POS_ffn = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/Field-Test-Ballance-20231220/R10-ROVER/OCC7-P3/SOLUTIONS/R10-ROVER-OCC7-P3-PPK-DNVK.POS"
X = anal_POS_generic(POS_ffn = POS_ffn, known_coords = get_peg_loc(3))


```




## 6. EML-OCC5-P2-PPK-DNVK ---

```{r}

REC = "EML"
OCC = 5
PEG = 2
MET = "PPK-DNVK"

POS_ffn_stub = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/FINAL_SOLUTIONS/"

POS_ffn_sdn = paste0(REC,"-OCC",OCC,"-P",PEG,"-",MET,".POS")
POS_ffn = paste0(POS_ffn_stub, POS_ffn_sdn)



X = anal_POS_generic(POS_ffn = POS_ffn, known_coords = get_peg_loc(PEG),POS_FMT = 5)


```


## 7. EML-OCC6-P8-PPK-DNVK ---

```{r}

REC = "EML"
OCC = 6
PEG = 8
MET = "PPK-DNVK"

POS_ffn_stub = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/FINAL_SOLUTIONS/"

POS_ffn_sdn = paste0(REC,"-OCC",OCC,"-P",PEG,"-",MET,".POS")
POS_ffn = paste0(POS_ffn_stub, POS_ffn_sdn)



X = anal_POS_generic(POS_ffn = POS_ffn, known_coords = get_peg_loc(PEG),POS_FMT = 5)


```


## 8. EML-OCC7-P4-PPK-DNVK ---

```{r}

REC = "EML"
OCC = 7
PEG = 4
MET = "PPK-DNVK"

POS_ffn_stub = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/FINAL_SOLUTIONS/"

POS_ffn_sdn = paste0(REC,"-OCC",OCC,"-P",PEG,"-",MET,".POS")
POS_ffn = paste0(POS_ffn_stub, POS_ffn_sdn)



X = anal_POS_generic(POS_ffn = POS_ffn, known_coords = get_peg_loc(PEG),POS_FMT = 5)


```

## 8. EML-OCC8-P6-PPK-DNVK ---

```{r}

REC = "EML"
OCC = 8
PEG = 6
MET = "PPK-DNVK"

POS_ffn_stub = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/FINAL_SOLUTIONS/"

POS_ffn_sdn = paste0(REC,"-OCC",OCC,"-P",PEG,"-",MET,".POS")
POS_ffn = paste0(POS_ffn_stub, POS_ffn_sdn)



X = anal_POS_generic(POS_ffn = POS_ffn, known_coords = get_peg_loc(PEG),POS_FMT = 5)


```


## 9. EML-OCC9-P2-PPK-DNVK ---

```{r}

REC = "EML"
OCC = 9
PEG = 1
MET = "PPK-DNVK"

POS_ffn_stub = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/FINAL_SOLUTIONS/"

POS_ffn_sdn = paste0(REC,"-OCC",OCC,"-P",PEG,"-",MET,".POS")
POS_ffn = paste0(POS_ffn_stub, POS_ffn_sdn)



X = anal_POS_generic(POS_ffn = POS_ffn, known_coords = get_peg_loc(PEG),POS_FMT = 5)


```

## 10. EML-OCC1-P7-PPK-DNVK ---

```{r}

REC = "EML"
OCC = 1
PEG = 7
MET = "PPK-DNVK"

POS_ffn_stub = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/FINAL_SOLUTIONS/"

POS_ffn_sdn = paste0(REC,"-OCC",OCC,"-P",PEG,"-",MET,".POS")
POS_ffn = paste0(POS_ffn_stub, POS_ffn_sdn)



X = anal_POS_generic(POS_ffn = POS_ffn, known_coords = get_peg_loc(PEG),POS_FMT = 5)


```

## 10. EML-OCC2-P6-PPK-DNVK ---

```{r}

REC = "EML"
OCC = 2
PEG = 6
MET = "PPK-DNVK"

POS_ffn_stub = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/FINAL_SOLUTIONS/"

POS_ffn_sdn = paste0(REC,"-OCC",OCC,"-P",PEG,"-",MET,".POS")
POS_ffn = paste0(POS_ffn_stub, POS_ffn_sdn)



X = anal_POS_generic(POS_ffn = POS_ffn, known_coords = get_peg_loc(PEG),POS_FMT = 5)


```

## 11. EML-OCC3-P3-PPK-DNVK ---

```{r}

REC = "EML"
OCC = 3
PEG = 3
MET = "PPK-DNVK"

POS_ffn_stub = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/FINAL_SOLUTIONS/"

POS_ffn_sdn = paste0(REC,"-OCC",OCC,"-P",PEG,"-",MET,".POS")
POS_ffn = paste0(POS_ffn_stub, POS_ffn_sdn)



X = anal_POS_generic(POS_ffn = POS_ffn, known_coords = get_peg_loc(PEG),POS_FMT = 5)


```

## 11. JVD-OCC3-P7-PPK-DNVK ---

```{r}

REC = "JVD"
OCC = 3
PEG = 7
MET = "PPK-DNVK"

POS_ffn_stub = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/FINAL_SOLUTIONS/"

POS_ffn_sdn = paste0(REC,"-OCC",OCC,"-P",PEG,"-",MET,".POS")
POS_ffn = paste0(POS_ffn_stub, POS_ffn_sdn)



X = anal_POS_generic(POS_ffn = POS_ffn, known_coords = get_peg_loc(PEG),POS_FMT = 5)


```

## 11. JVD-OCC5-P2-PPK-DNVK ---

```{r}

REC = "JVD"
OCC = 5
PEG = 5
MET = "PPK-DNVK"

POS_ffn_stub = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/FINAL_SOLUTIONS/"

POS_ffn_sdn = paste0(REC,"-OCC",OCC,"-P",PEG,"-",MET,".POS")
POS_ffn = paste0(POS_ffn_stub, POS_ffn_sdn)



X = anal_POS_generic(POS_ffn = POS_ffn, known_coords = get_peg_loc(PEG),POS_FMT = 5)


```

## 12. EML-OCC3-P3-PPK-DNVK ---

```{r}

REC = "EML"
OCC = 3
PEG = 3
MET = "PPK-DNVK"

POS_ffn_stub = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/FINAL_SOLUTIONS/"

POS_ffn_sdn = paste0(REC,"-OCC",OCC,"-P",PEG,"-",MET,".POS")
POS_ffn = paste0(POS_ffn_stub, POS_ffn_sdn)



X = anal_POS_generic(POS_ffn = POS_ffn, known_coords = get_peg_loc(PEG),POS_FMT = 5)


```

## 12. JVD-OCC6-P3-PPK-DNVK ---

```{r}

REC = "JVD"
OCC = 6
PEG = 3
MET = "PPK-DNVK"

POS_ffn_stub = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/FINAL_SOLUTIONS/"

POS_ffn_sdn = paste0(REC,"-OCC",OCC,"-P",PEG,"-",MET,".POS")
POS_ffn = paste0(POS_ffn_stub, POS_ffn_sdn)



X = anal_POS_generic(POS_ffn = POS_ffn, known_coords = get_peg_loc(PEG),POS_FMT = 5)


```

## 13. JVD-OCC7-P2-PPK-DNVK ---

```{r}

REC = "JVD"
OCC = 7
PEG = 2
MET = "PPK-DNVK"

POS_ffn_stub = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/FINAL_SOLUTIONS/"

POS_ffn_sdn = paste0(REC,"-OCC",OCC,"-P",PEG,"-",MET,".POS")
POS_ffn = paste0(POS_ffn_stub, POS_ffn_sdn)



X = anal_POS_generic(POS_ffn = POS_ffn, known_coords = get_peg_loc(PEG),POS_FMT = 5)


```

## 14. JVD-OCC8-P1-PPK-DNVK ---

```{r}

REC = "JVD"
OCC = 8
PEG = 1
MET = "PPK-DNVK"

POS_ffn_stub = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/FINAL_SOLUTIONS/"

POS_ffn_sdn = paste0(REC,"-OCC",OCC,"-P",PEG,"-",MET,".POS")
POS_ffn = paste0(POS_ffn_stub, POS_ffn_sdn)



X = anal_POS_generic(POS_ffn = POS_ffn, known_coords = get_peg_loc(PEG),POS_FMT = 5)


```

## 15. JVD-OCC9-P8-PPK-DNVK ---

```{r}

REC = "JVD"
OCC = 9
PEG = 8
MET = "PPK-DNVK"

POS_ffn_stub = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/FINAL_SOLUTIONS/"

POS_ffn_sdn = paste0(REC,"-OCC",OCC,"-P",PEG,"-",MET,".POS")
POS_ffn = paste0(POS_ffn_stub, POS_ffn_sdn)



X = anal_POS_generic(POS_ffn = POS_ffn, known_coords = get_peg_loc(PEG),POS_FMT = 5)


```

## 16. R10-ROVER-OCC5-P4-PPK-DNVK ---

```{r}

REC = "R10-ROVER"
OCC = 5
PEG = 4
MET = "PPK-DNVK"

POS_ffn_stub = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/FINAL_SOLUTIONS/"

POS_ffn_sdn = paste0(REC,"-OCC",OCC,"-P",PEG,"-",MET,".POS")
POS_ffn = paste0(POS_ffn_stub, POS_ffn_sdn)



X = anal_POS_generic(POS_ffn = POS_ffn, known_coords = get_peg_loc(PEG),POS_FMT = 5)


```

## 17. R10-ROVER-OCC3-P1-PPK-DNVK ---

```{r}

REC = "R10-ROVER"
OCC = 3
PEG = 1
MET = "PPK-DNVK"

POS_ffn_stub = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/FINAL_SOLUTIONS/"

POS_ffn_sdn = paste0(REC,"-OCC",OCC,"-P",PEG,"-",MET,".POS")
POS_ffn = paste0(POS_ffn_stub, POS_ffn_sdn)



X = anal_POS_generic(POS_ffn = POS_ffn, known_coords = get_peg_loc(PEG),POS_FMT = 5)


```

## 18. R10-ROVER-OCC3-P1-PPK-DNVK ---

```{r}

REC = "R10-ROVER"
OCC = 3
PEG = 1
MET = "PPK-DNVK"

POS_ffn_stub = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/FINAL_SOLUTIONS/"

POS_ffn_sdn = paste0(REC,"-OCC",OCC,"-P",PEG,"-",MET,".POS")
POS_ffn = paste0(POS_ffn_stub, POS_ffn_sdn)



X = anal_POS_generic(POS_ffn = POS_ffn, known_coords = get_peg_loc(PEG),POS_FMT = 5)


```

## 19. R10-ROVER-OCC6-P7-PPK-DNVK ---

```{r}

REC = "R10-ROVER"
OCC = 6
PEG = 7
MET = "PPK-DNVK"

POS_ffn_stub = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/FINAL_SOLUTIONS/"

POS_ffn_sdn = paste0(REC,"-OCC",OCC,"-P",PEG,"-",MET,".POS")
POS_ffn = paste0(POS_ffn_stub, POS_ffn_sdn)



X = anal_POS_generic(POS_ffn = POS_ffn, known_coords = get_peg_loc(PEG),POS_FMT = 5)


```

## 20. R10-ROVER-OCC7-P3-PPK-DNVK ---

```{r}

REC = "R10-ROVER"
OCC = 7
PEG = 3
MET = "PPK-DNVK"

POS_ffn_stub = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/FINAL_SOLUTIONS/"

POS_ffn_sdn = paste0(REC,"-OCC",OCC,"-P",PEG,"-",MET,".POS")
POS_ffn = paste0(POS_ffn_stub, POS_ffn_sdn)



X = anal_POS_generic(POS_ffn = POS_ffn, known_coords = get_peg_loc(PEG),POS_FMT = 5)


```

## 21. R10-ROVER-OCC8-P3-PPK-DNVK ---

```{r}

REC = "R10-ROVER"
OCC = 8
PEG = 2
MET = "PPK-DNVK"

POS_ffn_stub = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/FINAL_SOLUTIONS/"

POS_ffn_sdn = paste0(REC,"-OCC",OCC,"-P",PEG,"-",MET,".POS")
POS_ffn = paste0(POS_ffn_stub, POS_ffn_sdn)



X = anal_POS_generic(POS_ffn = POS_ffn, known_coords = get_peg_loc(PEG),POS_FMT = 5)


```

## 22. CAR-OCC1-P4-PPK-DNVK ---

```{r}

REC = "CAR"
OCC = 1
PEG = 4
MET = "PPK-DNVK"

POS_ffn_stub = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/FINAL_SOLUTIONS/"

POS_ffn_sdn = paste0(REC,"-OCC",OCC,"-P",PEG,"-",MET,".POS")
POS_ffn = paste0(POS_ffn_stub, POS_ffn_sdn)



X = anal_POS_generic(POS_ffn = POS_ffn, known_coords = get_peg_loc(PEG),POS_FMT = 5)


```

## 23. CAR-OCC2-P7-PPK-DNVK ---

```{r}

REC = "CAR"
OCC = 2
PEG = 7
MET = "PPK-DNVK"

POS_ffn_stub = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/FINAL_SOLUTIONS/"

POS_ffn_sdn = paste0(REC,"-OCC",OCC,"-P",PEG,"-",MET,".POS")
POS_ffn = paste0(POS_ffn_stub, POS_ffn_sdn)



X = anal_POS_generic(POS_ffn = POS_ffn, known_coords = get_peg_loc(PEG),POS_FMT = 5)


```

## 24. CAR-OCC1-P4-PPK-R10 ---

```{r}

REC = "CAR"
OCC = 1
PEG = 4
MET = "PPK-R10"

POS_ffn_stub = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/FINAL_SOLUTIONS/"

POS_ffn_sdn = paste0(REC,"-OCC",OCC,"-P",PEG,"-",MET,".POS")
POS_ffn = paste0(POS_ffn_stub, POS_ffn_sdn)



X = anal_POS_generic(POS_ffn = POS_ffn, known_coords = get_peg_loc(PEG),POS_FMT = 5)


```

## 25. CAR-OCC2-P7-PPK-R10 ---

```{r}

REC = "CAR"
OCC = 2
PEG = 7
MET = "PPK-R10"

POS_ffn_stub = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/FINAL_SOLUTIONS/"

POS_ffn_sdn = paste0(REC,"-OCC",OCC,"-P",PEG,"-",MET,".POS")
POS_ffn = paste0(POS_ffn_stub, POS_ffn_sdn)



X = anal_POS_generic(POS_ffn = POS_ffn, known_coords = get_peg_loc(PEG),POS_FMT = 5)


```

## 26. TOP-OCC1-P5-PPK-R10 ---

```{r}

REC = "TOP"
OCC = 1
PEG = 5
MET = "PPK-R10"

POS_ffn_stub = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/FINAL_SOLUTIONS/"

POS_ffn_sdn = paste0(REC,"-OCC",OCC,"-P",PEG,"-",MET," (1).POS")
POS_ffn = paste0(POS_ffn_stub, POS_ffn_sdn)

file.exists(POS_ffn)

X = anal_POS_generic(POS_ffn = POS_ffn, known_coords = get_peg_loc(PEG),POS_FMT = 5)


```

## 27. TOP-OCC1-P5-PPK-R10 ---

```{r}

REC = "TOP"
OCC = 2
PEG = 8
MET = "PPK-R10"

POS_ffn_stub = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/FINAL_SOLUTIONS/"

POS_ffn_sdn = paste0(REC,"-OCC",OCC,"-P",PEG,"-",MET,".POS")
POS_ffn = paste0(POS_ffn_stub, POS_ffn_sdn)

file.exists(POS_ffn)

X = anal_POS_generic(POS_ffn = POS_ffn, known_coords = get_peg_loc(PEG),POS_FMT = 5)


```

## 28. JVD-OCC1-P6-PPK-R10 ---

```{r}

REC = "JVD"
OCC = 1
PEG = 6
MET = "PPK-R10"

POS_ffn_stub = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/FINAL_SOLUTIONS/"

POS_ffn_sdn = paste0(REC,"-OCC",OCC,"-P",PEG,"-",MET,".POS")
POS_ffn = paste0(POS_ffn_stub, POS_ffn_sdn)

file.exists(POS_ffn)

X = anal_POS_generic(POS_ffn = POS_ffn, known_coords = get_peg_loc(PEG),POS_FMT = 5)


```

## 30 JVD-OCC2-P4-PPK-R10 ---

```{r}

REC = "JVD"
OCC = 2
PEG = 4
MET = "PPK-R10"

POS_ffn_stub = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/FINAL_SOLUTIONS/"

POS_ffn_sdn = paste0(REC,"-OCC",OCC,"-P",PEG,"-",MET,".POS")
POS_ffn = paste0(POS_ffn_stub, POS_ffn_sdn)

file.exists(POS_ffn)

X = anal_POS_generic(POS_ffn = POS_ffn, known_coords = get_peg_loc(PEG),POS_FMT = 5)


```

## 31 EML-OCC1-P7-PPK-R10 ---

```{r}

REC = "EML"
OCC = 1
PEG = 7
MET = "PPK-R10"

POS_ffn_stub = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/FINAL_SOLUTIONS/"

POS_ffn_sdn = paste0(REC,"-OCC",OCC,"-P",PEG,"-",MET,".POS")
POS_ffn = paste0(POS_ffn_stub, POS_ffn_sdn)

file.exists(POS_ffn)

X = anal_POS_generic(POS_ffn = POS_ffn, known_coords = get_peg_loc(PEG),POS_FMT = 5)


```

## 32 EML-OCC2-P6-PPK-R10 ---

```{r}

REC = "EML"
OCC = 2
PEG = 6
MET = "PPK-R10"

POS_ffn_stub = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/FINAL_SOLUTIONS/"

POS_ffn_sdn = paste0(REC,"-OCC",OCC,"-P",PEG,"-",MET,".POS")
POS_ffn = paste0(POS_ffn_stub, POS_ffn_sdn)

file.exists(POS_ffn)

X = anal_POS_generic(POS_ffn = POS_ffn, known_coords = get_peg_loc(PEG),POS_FMT = 5)


```

## 33 R10-ROVER-OCC1-P8-PPK-R10 ---

```{r}

REC = "R10-ROVER"
OCC = 1
PEG = 8
MET = "PPK-R10"

POS_ffn_stub = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/FINAL_SOLUTIONS/"

POS_ffn_sdn = paste0(REC,"-OCC",OCC,"-P",PEG,"-",MET,".POS")
POS_ffn = paste0(POS_ffn_stub, POS_ffn_sdn)

file.exists(POS_ffn)

X = anal_POS_generic(POS_ffn = POS_ffn, known_coords = get_peg_loc(PEG),POS_FMT = 5)


```

## 34 R10-ROVER-OCC2-P5-PPK-R10 ---

```{r}

REC = "R10-ROVER"
OCC = 2
PEG = 5
MET = "PPK-R10"

POS_ffn_stub = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/FINAL_SOLUTIONS/"

POS_ffn_sdn = paste0(REC,"-OCC",OCC,"-P",PEG,"-",MET,".POS")
POS_ffn = paste0(POS_ffn_stub, POS_ffn_sdn)

file.exists(POS_ffn)

X = anal_POS_generic(POS_ffn = POS_ffn, known_coords = get_peg_loc(PEG),POS_FMT = 5)


```

## 35 CAR-OCC2-P7-PPK-R10 ---

```{r}

REC = "CAR"
OCC = 2
PEG = 7
MET = "PPK-R10"

POS_ffn_stub = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/FINAL_SOLUTIONS/"

POS_ffn_sdn = paste0(REC,"-OCC",OCC,"-P",PEG,"-",MET,".POS")
POS_ffn = paste0(POS_ffn_stub, POS_ffn_sdn)

file.exists(POS_ffn)

X = anal_POS_generic(POS_ffn = POS_ffn, known_coords = get_peg_loc(PEG),POS_FMT = 5)


```

## 36 EML-OCC5-P2-PPK-R10 ---

```{r}

REC = "EML"
OCC = 5
PEG = 2
MET = "PPK-R10"

POS_ffn_stub = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/FINAL_SOLUTIONS/"

POS_ffn_sdn = paste0(REC,"-OCC",OCC,"-P",PEG,"-",MET,".POS")
POS_ffn = paste0(POS_ffn_stub, POS_ffn_sdn)

file.exists(POS_ffn)

X = anal_POS_generic(POS_ffn = POS_ffn, known_coords = get_peg_loc(PEG),POS_FMT = 5)


```

## 37 JVD-OCC6-P3-PPK-R10 ---

```{r}

REC = "JVD"
OCC = 6
PEG = 3
MET = "PPK-R10"

POS_ffn_stub = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/FINAL_SOLUTIONS/"

POS_ffn_sdn = paste0(REC,"-OCC",OCC,"-P",PEG,"-",MET,".POS")
POS_ffn = paste0(POS_ffn_stub, POS_ffn_sdn)

file.exists(POS_ffn)

X = anal_POS_generic(POS_ffn = POS_ffn, known_coords = get_peg_loc(PEG),POS_FMT = 5)


```

## 38 TOP-OCC1-P5-PPK-DNVK ---

```{r}

REC = "TOP"
OCC = 1
PEG = 5
MET = "PPK-DNVK"

POS_ffn_stub = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/FINAL_SOLUTIONS/"

POS_ffn_sdn = paste0(REC,"-OCC",OCC,"-P",PEG,"-",MET,".POS")
POS_ffn = paste0(POS_ffn_stub, POS_ffn_sdn)

file.exists(POS_ffn)

X = anal_POS_generic(POS_ffn = POS_ffn, known_coords = get_peg_loc(PEG),POS_FMT = 5)


```

## 39 TOP-OCC2-P8-PPK-DNVK ---

```{r}

REC = "TOP"
OCC = 2
PEG = 8
MET = "PPK-DNVK"

POS_ffn_stub = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/FINAL_SOLUTIONS/"

POS_ffn_sdn = paste0(REC,"-OCC",OCC,"-P",PEG,"-",MET,".POS")
POS_ffn = paste0(POS_ffn_stub, POS_ffn_sdn)

file.exists(POS_ffn)

X = anal_POS_generic(POS_ffn = POS_ffn, known_coords = get_peg_loc(PEG),POS_FMT = 5)


```


## 40 TOP-OCC1-P5-PPK-R10 ---

```{r}

REC = "TOP"
OCC = 1
PEG = 5
MET = "PPK-R10"

POS_ffn_stub = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/FINAL_SOLUTIONS/"

POS_ffn_sdn = paste0(REC,"-OCC",OCC,"-P",PEG,"-",MET,".POS")
POS_ffn = paste0(POS_ffn_stub, POS_ffn_sdn)

file.exists(POS_ffn)

X = anal_POS_generic(POS_ffn = POS_ffn, known_coords = get_peg_loc(PEG),POS_FMT = 5)


```

## 41 TOP-OCC2-P8-PPK-R10 ---

```{r}

REC = "TOP"
OCC = 2
PEG = 8
MET = "PPK-R10"

POS_ffn_stub = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/FINAL_SOLUTIONS/"

POS_ffn_sdn = paste0(REC,"-OCC",OCC,"-P",PEG,"-",MET,".POS")
POS_ffn = paste0(POS_ffn_stub, POS_ffn_sdn)

file.exists(POS_ffn)

X = anal_POS_generic(POS_ffn = POS_ffn, known_coords = get_peg_loc(PEG),POS_FMT = 5)


```

## 42 R10-ROVER-OCC5-P4-PPK-R10 ---

```{r}

REC = "R10-ROVER"
OCC = 5
PEG = 4
MET = "PPK-R10"

POS_ffn_stub = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/FINAL_SOLUTIONS/"

POS_ffn_sdn = paste0(REC,"-OCC",OCC,"-P",PEG,"-",MET,".POS")
POS_ffn = paste0(POS_ffn_stub, POS_ffn_sdn)

file.exists(POS_ffn)

X = anal_POS_generic(POS_ffn = POS_ffn, known_coords = get_peg_loc(PEG),POS_FMT = 5)


```

## 43 JVD-OCC5-P5-PPK-R10 ---

```{r}

REC = "JVD"
OCC = 5
PEG = 5
MET = "PPK-R10"

POS_ffn_stub = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/FINAL_SOLUTIONS/"

POS_ffn_sdn = paste0(REC,"-OCC",OCC,"-P",PEG,"-",MET,".POS")
POS_ffn = paste0(POS_ffn_stub, POS_ffn_sdn)

file.exists(POS_ffn)

X = anal_POS_generic(POS_ffn = POS_ffn, known_coords = get_peg_loc(PEG),POS_FMT = 5)


```

## 44 R10-ROVER-OCC5-P5-PPK-R10 ---

```{r}

REC = "R10-ROVER"
OCC = 6
PEG = 7
MET = "PPK-R10"

POS_ffn_stub = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/FINAL_SOLUTIONS/"

POS_ffn_sdn = paste0(REC,"-OCC",OCC,"-P",PEG,"-",MET,".POS")
POS_ffn = paste0(POS_ffn_stub, POS_ffn_sdn)

file.exists(POS_ffn)

X = anal_POS_generic(POS_ffn = POS_ffn, known_coords = get_peg_loc(PEG),POS_FMT = 5)


```




## 45 EML-OCC6-P8-PPK-R10 ---

```{r}

REC = "EML"
OCC = 6
PEG = 8
MET = "PPK-R10"

POS_ffn_stub = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/FINAL_SOLUTIONS/"

POS_ffn_sdn = paste0(REC,"-OCC",OCC,"-P",PEG,"-",MET,".POS")
POS_ffn = paste0(POS_ffn_stub, POS_ffn_sdn)

file.exists(POS_ffn)

X = anal_POS_generic(POS_ffn = POS_ffn, known_coords = get_peg_loc(PEG),POS_FMT = 5)


```

## 46 JVD-OCC7-P2-PPK-R10 ---

```{r}

REC = "JVD"
OCC = 7
PEG = 2
MET = "PPK-R10"

POS_ffn_stub = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/FINAL_SOLUTIONS/"

POS_ffn_sdn = paste0(REC,"-OCC",OCC,"-P",PEG,"-",MET,".POS")
POS_ffn = paste0(POS_ffn_stub, POS_ffn_sdn)

file.exists(POS_ffn)

X = anal_POS_generic(POS_ffn = POS_ffn, known_coords = get_peg_loc(PEG),POS_FMT = 5)


```




## 47 R10-ROVER-OCC7-P3-PPK-R10 ---

```{r}

REC = "R10-ROVER"
OCC = 7
PEG = 3
MET = "PPK-R10"

POS_ffn_stub = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/FINAL_SOLUTIONS/"

POS_ffn_sdn = paste0(REC,"-OCC",OCC,"-P",PEG,"-",MET,".POS")
POS_ffn = paste0(POS_ffn_stub, POS_ffn_sdn)

file.exists(POS_ffn)

X = anal_POS_generic(POS_ffn = POS_ffn, known_coords = get_peg_loc(PEG),POS_FMT = 5)


```




## 48 EML-OCC7-P4-PPK-R10 ---

```{r}

REC = "EML"
OCC = 7
PEG = 4
MET = "PPK-R10"

POS_ffn_stub = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/FINAL_SOLUTIONS/"

POS_ffn_sdn = paste0(REC,"-OCC",OCC,"-P",PEG,"-",MET,".POS")
POS_ffn = paste0(POS_ffn_stub, POS_ffn_sdn)

file.exists(POS_ffn)

X = anal_POS_generic(POS_ffn = POS_ffn, known_coords = get_peg_loc(PEG),POS_FMT = 5)


```




## 48 JVD-OCC8-P1-PPK-R10 ---

```{r}

REC = "JVD"
OCC = 8
PEG = 1
MET = "PPK-R10"

POS_ffn_stub = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/FINAL_SOLUTIONS/"

POS_ffn_sdn = paste0(REC,"-OCC",OCC,"-P",PEG,"-",MET,".POS")
POS_ffn = paste0(POS_ffn_stub, POS_ffn_sdn)

file.exists(POS_ffn)

X = anal_POS_generic(POS_ffn = POS_ffn, known_coords = get_peg_loc(PEG),POS_FMT = 5)


```




## 49 R10-ROVER-OCC8-P2-PPK-R10 ---

```{r}

REC = "R10-ROVER"
OCC = 8
PEG = 2
MET = "PPK-R10"

POS_ffn_stub = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/FINAL_SOLUTIONS/"

POS_ffn_sdn = paste0(REC,"-OCC",OCC,"-P",PEG,"-",MET,".POS")
POS_ffn = paste0(POS_ffn_stub, POS_ffn_sdn)

file.exists(POS_ffn)

X = anal_POS_generic(POS_ffn = POS_ffn, known_coords = get_peg_loc(PEG),POS_FMT = 5)


```





## 50 EML-OCC8-P6-PPK-R10 ---

```{r}

REC = "EML"
OCC = 8
PEG = 6
MET = "PPK-R10"

POS_ffn_stub = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/FINAL_SOLUTIONS/"

POS_ffn_sdn = paste0(REC,"-OCC",OCC,"-P",PEG,"-",MET,".POS")
POS_ffn = paste0(POS_ffn_stub, POS_ffn_sdn)

file.exists(POS_ffn)

X = anal_POS_generic(POS_ffn = POS_ffn, known_coords = get_peg_loc(PEG),POS_FMT = 5)


```





## 50 JVD-OCC9-P8-PPK-R10 ---

```{r}

REC = "JVD"
OCC = 9
PEG = 8
MET = "PPK-R10"

POS_ffn_stub = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/FINAL_SOLUTIONS/"

POS_ffn_sdn = paste0(REC,"-OCC",OCC,"-P",PEG,"-",MET,".POS")
POS_ffn = paste0(POS_ffn_stub, POS_ffn_sdn)

file.exists(POS_ffn)

X = anal_POS_generic(POS_ffn = POS_ffn, known_coords = get_peg_loc(PEG),POS_FMT = 5)


```

## 51 EML-OCC9-P1-PPK-R10 ---

```{r}

REC = "EML"
OCC = 9
PEG = 1
MET = "PPK-R10"

POS_ffn_stub = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/FINAL_SOLUTIONS/"

POS_ffn_sdn = paste0(REC,"-OCC",OCC,"-P",PEG,"-",MET,".POS")
POS_ffn = paste0(POS_ffn_stub, POS_ffn_sdn)

file.exists(POS_ffn)

X = anal_POS_generic(POS_ffn = POS_ffn, known_coords = get_peg_loc(PEG),POS_FMT = 5)


```


#===========================================================================
# PPK-DNVK
#===========================================================================

```{r}
#=================================================

SOLN = proc_pos("CAR", 1, 4, "PPK-DNVK")
SOLN = proc_pos("TOP", 1, 5, "PPK-DNVK")
SOLN = proc_pos("JVD", 1, 6, "PPK-DNVK")
SOLN = proc_pos("EML", 1, 7, "PPK-DNVK")
SOLN = proc_pos("R10-ROVER", 1, 8, "PPK-DNVK")

SOLN = proc_pos("JVD", 2, 4, "PPK-DNVK")
SOLN = proc_pos("R10-ROVER", 2, 5, "PPK-DNVK")
SOLN = proc_pos("EML", 2, 6, "PPK-DNVK")
SOLN = proc_pos("CAR", 2, 7, "PPK-DNVK")
SOLN = proc_pos("TOP", 2, 8, "PPK-DNVK")

SOLN = proc_pos("R10-ROVER", 3, 1, "PPK-DNVK")
SOLN = proc_pos("EML", 3, 3, "PPK-DNVK")
SOLN = proc_pos("JVD", 3, 7, "PPK-DNVK")

SOLN = proc_pos("R10-ROVER", 5, 4, "PPK-DNVK")
SOLN = proc_pos("EML", 5, 2, "PPK-DNVK")
SOLN = proc_pos("JVD", 5, 5, "PPK-DNVK")

SOLN = proc_pos("R10-ROVER", 6, 7, "PPK-DNVK")
SOLN = proc_pos("EML", 6, 8, "PPK-DNVK")
SOLN = proc_pos("JVD", 6, 3, "PPK-DNVK")

SOLN = proc_pos("JVD", 7, 2, "PPK-DNVK")
SOLN = proc_pos("R10-ROVER", 7, 3, "PPK-DNVK")
SOLN = proc_pos("EML", 7, 4, "PPK-DNVK")

SOLN = proc_pos("JVD", 8, 1, "PPK-DNVK")
SOLN = proc_pos("R10-ROVER", 8, 2, "PPK-DNVK")
SOLN = proc_pos("EML", 8, 6, "PPK-DNVK")

SOLN = proc_pos("JVD", 9, 8, "PPK-DNVK")
SOLN = proc_pos("EML", 9, 1, "PPK-DNVK")

#=================================================
```


#===========================================================================
# PPK-WRPA
#===========================================================================

```{r}
SOLN = proc_pos("CAR", 1, 4, "PPK-WRPA")
SOLN = proc_pos("TOP", 1, 5, "PPK-WRPA")
SOLN = proc_pos("JVD", 1, 6, "PPK-WRPA")
SOLN = proc_pos("EML", 1, 7, "PPK-WRPA")
SOLN = proc_pos("R10-ROVER", 1, 8, "PPK-WRPA")

SOLN = proc_pos("JVD", 2, 4, "PPK-WRPA")
SOLN = proc_pos("R10-ROVER", 2, 5, "PPK-WRPA")
SOLN = proc_pos("EML", 2, 6, "PPK-WRPA")
SOLN = proc_pos("CAR", 2, 7, "PPK-WRPA")
SOLN = proc_pos("TOP", 2, 8, "PPK-WRPA")

SOLN = proc_pos("R10-ROVER", 3, 1, "PPK-WRPA")
SOLN = proc_pos("EML", 3, 3, "PPK-WRPA")
SOLN = proc_pos("JVD", 3, 7, "PPK-WRPA")

SOLN = proc_pos("R10-ROVER", 5, 4, "PPK-WRPA")
SOLN = proc_pos("EML", 5, 2, "PPK-WRPA")
SOLN = proc_pos("JVD", 5, 5, "PPK-WRPA")

SOLN = proc_pos("R10-ROVER", 6, 7, "PPK-WRPA")
SOLN = proc_pos("EML", 6, 8, "PPK-WRPA")
SOLN = proc_pos("JVD", 6, 3, "PPK-WRPA")

SOLN = proc_pos("JVD", 7, 2, "PPK-WRPA")
SOLN = proc_pos("R10-ROVER", 7, 3, "PPK-WRPA")
SOLN = proc_pos("EML", 7, 4, "PPK-WRPA")

SOLN = proc_pos("JVD", 8, 1, "PPK-WRPA")
SOLN = proc_pos("R10-ROVER", 8, 2, "PPK-WRPA")
SOLN = proc_pos("EML", 8, 6, "PPK-WRPA")

SOLN = proc_pos("JVD", 9, 8, "PPK-WRPA")
SOLN = proc_pos("EML", 9, 1, "PPK-WRPA")

#=================================================
```


#===========================================================================
# PPK-R10
#===========================================================================


```{r}
SOLN = proc_pos("CAR", 1, 4, "PPK-R10")
SOLN = proc_pos("TOP", 1, 5, "PPK-R10")
SOLN = proc_pos("JVD", 1, 6, "PPK-R10")
SOLN = proc_pos("EML", 1, 7, "PPK-R10")
SOLN = proc_pos("R10-ROVER", 1, 8, "PPK-R10")

SOLN = proc_pos("JVD", 2, 4, "PPK-R10")
SOLN = proc_pos("R10-ROVER", 2, 5, "PPK-R10")
SOLN = proc_pos("EML", 2, 6, "PPK-R10")
SOLN = proc_pos("CAR", 2, 7, "PPK-R10")
SOLN = proc_pos("TOP", 2, 8, "PPK-R10")

SOLN = proc_pos("R10-ROVER", 3, 1, "PPK-R10")
SOLN = proc_pos("EML", 3, 3, "PPK-R10")
SOLN = proc_pos("JVD", 3, 7, "PPK-R10")

SOLN = proc_pos("R10-ROVER", 5, 4, "PPK-R10")
SOLN = proc_pos("EML", 5, 2, "PPK-R10")
SOLN = proc_pos("JVD", 5, 5, "PPK-R10")

SOLN = proc_pos("R10-ROVER", 6, 7, "PPK-R10")
SOLN = proc_pos("EML", 6, 8, "PPK-R10")
SOLN = proc_pos("JVD", 6, 3, "PPK-R10")

SOLN = proc_pos("JVD", 7, 2, "PPK-R10")
SOLN = proc_pos("R10-ROVER", 7, 3, "PPK-R10")
SOLN = proc_pos("EML", 7, 4, "PPK-R10")

SOLN = proc_pos("JVD", 8, 1, "PPK-R10")
SOLN = proc_pos("R10-ROVER", 8, 2, "PPK-R10")
SOLN = proc_pos("EML", 8, 6, "PPK-R10")

SOLN = proc_pos("JVD", 9, 8, "PPK-R10")
SOLN = proc_pos("EML", 9, 1, "PPK-R10")
```
# Read Work So Far

```{r}
#Get the known locations of the Pegs

KnownPegPositions_binary_ffn = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/KnownPegPositions.RDS"

pegloctab = readRDS(KnownPegPositions_binary_ffn) %>% 
  mutate(PegNum = substr(Peg,6,6)) 

names(pegloctab)[2] = "EASTING_TRUE"
names(pegloctab)[3] = "NORTHING_TRUE"
names(pegloctab)[4] = "ELEVATION_TRUE"
#  


#rEAD THE data for the receivers

xl_ffn = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/GNSS_DATA_COLLATED.xlsx"
xl_page = "RECEIVERS"
xl_rng = "B3:D13"



REC_DATA = readxl::read_excel(xl_ffn, sheet = xl_page, range = xl_rng) 



#rEAD THE FINAL rSULTS tABLE

xl_ffn = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/GNSS_DATA_COLLATED.xlsx"
xl_page = "FINAL RESULTS"
xl_rng = "A1:O200"



D = readxl::read_excel(xl_ffn, sheet = xl_page, range = xl_rng) %>% 
  left_join(pegloctab, by = c("PEG"="PegNum")) %>% 
  left_join(REC_DATA, by = c("REC"="CODE"))


# plot the PPK from the DNVK

D_DNVK = D %>% 
  filter(   (MET == "PPK-DNVK" | MET == "PPK-DNVK-TBC") & !is.na(REC) &  !is.na(PEG) & REC != "KIS") %>% 
  #remove the R10-Rover Entries that were not processed by TBC
  filter( (MET == "PPK-DNVK" & REC != "R10-Rover" ) | MET == "PPK-DNVK-TBC")  



```


```{r}

g = ggplot(D_DNVK) + geom_bar(aes(PEG,`ACC FLOAT`), stat = "identity", width = .7) + facet_wrap(~RECEIVER)

g = g + geom_errorbar(aes(x = PEG, ymin = `ACC FLOAT` ,ymax = `ACC FLOAT` + `PREC FLOAT`), width = .4)

g = g + labs(x = "Peg Number", y = "Accuracy (m)")

g = g + geom_hline(aes(yintercept = 1), color = "red", linetype = "dashed")
g = g + geom_hline(aes(yintercept = 0.5), color = "red", linetype = "dotted")

g = g + theme_bw()

g
```

# Do a final re-collation of all the PPK *.POS files, outputting a fuller data set

```{r}

#specify the location of the OCC_TBL
OCC_TBL_ffn = paste0(datadir, "OCC_TBL.RDS")

#read the OCC_TBL - the list of all the occupations
OCC_TBL = readRDS(OCC_TBL_ffn) 


recollate=T
if (recollate){
  
  PPK_DNVK_COLLATED_TMP = collate_ppk(MET="PPK-DNVK", OCC_TBL_ffn) 
  PPK_DNVK_COLLATED = OCC_TBL %>% 
    left_join(PPK_DNVK_COLLATED_TMP, by = c("POS_ffn"="POS_fn" )) %>% 
    mutate(MET = "PPK-DNVK")
  
  write_csv(PPK_DNVK_COLLATED, paste0(datadir, "PPK_DNVK_COLL.csv"))
  
  PPK_WRPA_COLLATED_TMP = collate_ppk(MET="PPK-WRPA", OCC_TBL_ffn) 
  PPK_WRPA_COLLATED = OCC_TBL %>% 
    left_join(PPK_WRPA_COLLATED_TMP, by = c("POS_ffn"="POS_fn" )) %>% 
    mutate(MET = "PPK-WRPA")
  
  write_csv(PPK_WRPA_COLLATED, paste0(datadir, "PPK_WRPA_COLL.csv"))
  
  PPK_R10_COLLATED_TMP = collate_ppk(MET="PPK-R10", OCC_TBL_ffn) 
  PPK_R10_COLLATED = OCC_TBL %>% 
    left_join(PPK_R10_COLLATED_TMP, by = c("POS_ffn"="POS_fn" )) %>% 
    mutate(MET = "PPK-R10")
  
  write_csv(PPK_R10_COLLATED, paste0(datadir, "PPK_R10_COLL.csv"))
  
  PPK_ALL_COLLATED = PPK_DNVK_COLLATED %>% 
    bind_rows(PPK_WRPA_COLLATED) %>% 
    bind_rows(PPK_R10_COLLATED)
  
  write_csv(PPK_ALL_COLLATED, paste0(datadir, "PPK_ALL_COLL.csv"))
  
} else {
  
  PPK_DNVK_COLLATED = read_csv(paste0(datadir, "PPK_DNVK_COLL.csv"))
  PPK_WRPA_COLLATED = read_csv(paste0(datadir, "PPK_WRPA_COLL.csv"))
  PPK_R10_COLLATED = read_csv(paste0(datadir, "PPK_R10_COLL.csv"))
  
  PPK_ALL_COLLATED = read_csv(paste0(datadir, "PPK_ALL_COLL.csv"))
  
  
  
}







```

#=====================================
#   -----------------------------------------------------------------
# ANALYSE THE FINAL COLLATED DATA 
#   -----------------------------------------------------------------
#=====================================


```{r}

PPK_ALL_COLLATED = read_csv(paste0(datadir, "PPK_ALL_COLL.csv"))

cMET = "PPK-DNVK"
PPK_ALL_COLLATED_DNVK = PPK_ALL_COLLATED %>% 
  filter(
    MET==cMET & 
      REC != "KIS" & 
      !(REC=="TOP" & OCC==3) &
      !(MET=="PPK-R10" & OCC==3)) %>% 
  mutate(
    PEG_LAB = paste0("Peg ", PEG)
  )

cMET = "PPK-WRPA"
PPK_ALL_COLLATED_WRPA = PPK_ALL_COLLATED %>% 
  filter(
    MET==cMET & 
      REC != "KIS" & 
      !(REC=="TOP" & OCC==3) &
      !(MET=="PPK-R10" & OCC==3)) %>% 
  mutate(
    PEG_LAB = paste0("Peg ", PEG)
  )


cMET = "PPK-R10"
PPK_ALL_COLLATED_R10 = PPK_ALL_COLLATED %>% 
  filter(
    MET==cMET & 
      REC != "KIS" & 
      !(REC=="TOP" & OCC==3) &
      !(MET=="PPK-R10" & OCC==3)) %>% 
  mutate(
    PEG_LAB = paste0("Peg ", PEG)
  )


```

# ~~~~~~~~~~~~~~~~ #
# Figure 4001 -  PPK-DNVK Accuracy-vs-Rcvr-by-Peg
# ~~~~~~~~~~~~~~~~ #

```{r}

fignum = 4001
figdesc = "PPK-DNVK-Accuracy-split by REC"
figfmt = "png"
fig_ffn = paste0(plotdir, fignum,"-", figdesc, ".", figfmt)

alp = .3

axlim = 2.01

g = ggplot(PPK_ALL_COLLATED_DNVK) 
g = g + lims(x = c(-axlim,axlim), y = c(-axlim,axlim))
g = g + geom_hline(aes(yintercept = 0), color = "red", linetype = "dashed", alpha = alp)
g = g + geom_vline(aes(xintercept = 0), color = "red", linetype = "dashed", alpha = alp)
g = g + geom_circle(aes(x0 = 0, y0=0, r=1), color = "red", linetype = "dashed", alpha = alp)
g = g + geom_circle(aes(x0 = 0, y0=0, r=0.5), color = "red", linetype = "dashed", alpha = alp)

g = g+ geom_point(aes(DEL_LON_avg , DEL_LAT_avg , color = RECEIVER), size = 2) + facet_wrap(~PEG_LAB, nrow = 3)
g = g + labs(x = expression(paste(Delta," Easting (m)")),y = expression(paste(Delta," Northing (m)")))

g = g + scale_color_manual(values = cbbPalette)
g = g + guides(color=guide_legend(title="GNSS Receiver"))

g = g +coord_fixed(ratio=1)
g = g + theme_bw() +
  theme(
    strip.background =element_rect(fill="white"),
    axis.title =  element_text(size = 12),
    legend.position = c(0.87,0.13))
# axis.title = element_text(size = 16))
g

WD = 28
HT = 8/18*28

specdim = F


ggsave(filename = fig_ffn, plot = g, width = WD, height = HT, units = "cm", bg = "white")

if (specdim){
  ggsave(filename = fig_ffn, plot = g, width = WD, height = HT, units = "cm", bg = "white")
} else {
  ggsave(filename = fig_ffn, plot = g,  units = "cm", bg = "white")
}


```

# ~~~~~~~~~~~~~~~~ #
# Figure 4002 -  PPK-DNVK Accuracy-at-each-peg-by-receiver
# ~~~~~~~~~~~~~~~~ #

```{r}

fignum = 4002
figdesc = "PPK-DNVK Accuracy-at-each-peg-by-receiver"
figfmt = "png"
fig_ffn = paste0(plotdir, fignum,"-", figdesc, ".", figfmt)

alp = .3

axlim = 2.01

g = ggplot(PPK_ALL_COLLATED_MET) 
g = g + lims(x = c(-axlim,axlim), y = c(-axlim,axlim))
g = g + geom_hline(aes(yintercept = 0), color = "red", linetype = "dashed", alpha = alp)
g = g + geom_vline(aes(xintercept = 0), color = "red", linetype = "dashed", alpha = alp)
g = g + geom_circle(aes(x0 = 0, y0=0, r=1), color = "red", linetype = "dashed", alpha = alp)
g = g + geom_circle(aes(x0 = 0, y0=0, r=0.5), color = "red", linetype = "dashed", alpha = alp)


g = g + geom_circle(aes(x0 = DEL_LON_avg, y0=DEL_LAT_avg, r=M_PREC, fill = PEG_LAB), linetype=0 , alpha = .5)


g = g+ geom_point(aes(DEL_LON_avg , DEL_LAT_avg, color = PEG_LAB ), size = 2) + facet_wrap(~RECEIVER, nrow = 2)
g = g + labs(x = expression(paste(Delta," Easting (m)")),y = expression(paste(Delta," Northing (m)")))

g = g + scale_color_manual(values = pegPalette)
g = g + scale_fill_manual(values = pegPalette)


g = g + guides(color=guide_legend("Peg"), fill = "none")

g = g +coord_fixed(ratio=1)
g = g + theme_bw() +
  theme(
    strip.background =element_rect(fill="white"),
    axis.title =  element_text(size = 12),
    legend.position = "bottom")
# axis.title = element_text(size = 16))
g

WD = 28
HT = 8/18*28

specdim = F


ggsave(filename = fig_ffn, plot = g, width = WD, height = HT, units = "cm", bg = "white")

if (specdim){
  ggsave(filename = fig_ffn, plot = g, width = WD, height = HT, units = "cm", bg = "white")
} else {
  ggsave(filename = fig_ffn, plot = g,  units = "cm", bg = "white")
}


```

# ~~~~~~~~~~~~~~~~ #
# Figure 4003 -  PPK-DNVK-Accuracy-for-each-occupation-by-receiver
# ~~~~~~~~~~~~~~~~ #

```{r}

fignum = 4003
figdesc = "PPK-DNVK-Accuracy-for-each-occupation-by-receiver"
figfmt = "png"
fig_ffn = paste0(plotdir, fignum,"-", figdesc, ".", figfmt)

alp = .3

axlim = 2.01

g = ggplot(PPK_ALL_COLLATED_DNVK) 
g = g + lims(x = c(-axlim,axlim), y = c(-axlim,axlim))
g = g + geom_hline(aes(yintercept = 0), color = "red", linetype = "dashed", alpha = alp)
g = g + geom_vline(aes(xintercept = 0), color = "red", linetype = "dashed", alpha = alp)
g = g + geom_circle(aes(x0 = 0, y0=0, r=1), color = "red", linetype = "dashed", alpha = alp)
g = g + geom_circle(aes(x0 = 0, y0=0, r=0.5), color = "red", linetype = "dashed", alpha = alp)


g = g + geom_circle(aes(x0 = DEL_LON_avg, y0=DEL_LAT_avg, r=M_PREC, fill = as.character(OCC)), linetype=0 , alpha = .5)


g = g+ geom_point(aes(DEL_LON_avg , DEL_LAT_avg, color = as.character(OCC) ), size = 2) + facet_wrap(~RECEIVER, nrow = 2)
g = g + labs(x = expression(paste(Delta," Easting (m)")),y = expression(paste(Delta," Northing (m)")))

g = g + scale_color_manual(values = pegPalette)
g = g + scale_fill_manual(values = pegPalette)


g = g + guides(color=guide_legend("Occupation \nnumber"), fill = "none")

g = g +coord_fixed(ratio=1)
g = g + theme_bw() +
  theme(
    strip.background =element_rect(fill="white"),
    axis.title =  element_text(size = 12),
    legend.position = "bottom")
# axis.title = element_text(size = 16))
g

WD = 28
HT = 8/18*28

specdim = F


ggsave(filename = fig_ffn, plot = g, width = WD, height = HT, units = "cm", bg = "white")

if (specdim){
  ggsave(filename = fig_ffn, plot = g, width = WD, height = HT, units = "cm", bg = "white")
} else {
  ggsave(filename = fig_ffn, plot = g,  units = "cm", bg = "white")
}


```


# ~~~~~~~~~~~~~~~~ #
# Figure 5001 -  PPK-WRPA Accuracy-vs-Rcvr-by-Peg
# ~~~~~~~~~~~~~~~~ #

```{r}

fignum = 5001
figdesc = "PPK-WRPA-Accuracy-split by REC"
figfmt = "png"
fig_ffn = paste0(plotdir, fignum,"-", figdesc, ".", figfmt)

alp = .3

axlim = 2.01

g = ggplot(PPK_ALL_COLLATED_WRPA) 
g = g + lims(x = c(-axlim,axlim), y = c(-axlim,axlim))
g = g + geom_hline(aes(yintercept = 0), color = "red", linetype = "dashed", alpha = alp)
g = g + geom_vline(aes(xintercept = 0), color = "red", linetype = "dashed", alpha = alp)
g = g + geom_circle(aes(x0 = 0, y0=0, r=1), color = "red", linetype = "dashed", alpha = alp)
g = g + geom_circle(aes(x0 = 0, y0=0, r=0.5), color = "red", linetype = "dashed", alpha = alp)

g = g+ geom_point(aes(DEL_LON_avg , DEL_LAT_avg , color = RECEIVER), size = 2) + facet_wrap(~PEG_LAB, nrow = 3)
g = g + labs(x = expression(paste(Delta," Easting (m)")),y = expression(paste(Delta," Northing (m)")))



g = g + scale_color_manual(values = cbbPalette)
g = g + guides(color=guide_legend(title="GNSS Receiver"))

g = g +coord_fixed(ratio=1)
g = g + theme_bw() +
  theme(
    strip.background =element_rect(fill="white"),
    axis.title =  element_text(size = 12),
    legend.position = c(0.87,0.13))
# axis.title = element_text(size = 16))
g

WD = 28
HT = 8/18*28

specdim = F


ggsave(filename = fig_ffn, plot = g, width = WD, height = HT, units = "cm", bg = "white")

if (specdim){
  ggsave(filename = fig_ffn, plot = g, width = WD, height = HT, units = "cm", bg = "white")
} else {
  ggsave(filename = fig_ffn, plot = g,  units = "cm", bg = "white")
}


```

# ~~~~~~~~~~~~~~~~ #
# Figure 5002 -  PPK-WRPA Accuracy-at-each-peg-by-receiver
# ~~~~~~~~~~~~~~~~ #

```{r}

fignum = 5002
figdesc = "PPK-WRPA Accuracy-at-each-peg-by-receiver"
figfmt = "png"
fig_ffn = paste0(plotdir, fignum,"-", figdesc, ".", figfmt)

alp = .3

axlim = 2.01

g = ggplot(PPK_ALL_COLLATED_WRPA) 
g = g + lims(x = c(-axlim,axlim), y = c(-axlim,axlim))
g = g + geom_hline(aes(yintercept = 0), color = "red", linetype = "dashed", alpha = alp)
g = g + geom_vline(aes(xintercept = 0), color = "red", linetype = "dashed", alpha = alp)
g = g + geom_circle(aes(x0 = 0, y0=0, r=1), color = "red", linetype = "dashed", alpha = alp)
g = g + geom_circle(aes(x0 = 0, y0=0, r=0.5), color = "red", linetype = "dashed", alpha = alp)


g = g + geom_circle(aes(x0 = DEL_LON_avg, y0=DEL_LAT_avg, r=M_PREC, fill = PEG_LAB), linetype=0 , alpha = .5)


g = g+ geom_point(aes(DEL_LON_avg , DEL_LAT_avg, color = PEG_LAB ), size = 2) + facet_wrap(~RECEIVER, nrow = 2)
g = g + labs(x = expression(paste(Delta," Easting (m)")),y = expression(paste(Delta," Northing (m)")))

g = g + scale_color_manual(values = pegPalette)
g = g + scale_fill_manual(values = pegPalette)


g = g + guides(color=guide_legend("Peg"), fill = "none")

g = g +coord_fixed(ratio=1)
g = g + theme_bw() +
  theme(
    strip.background =element_rect(fill="white"),
    axis.title =  element_text(size = 12),
    legend.position = "bottom")
# axis.title = element_text(size = 16))
g

WD = 28
HT = 8/18*28

specdim = F


ggsave(filename = fig_ffn, plot = g, width = WD, height = HT, units = "cm", bg = "white")

if (specdim){
  ggsave(filename = fig_ffn, plot = g, width = WD, height = HT, units = "cm", bg = "white")
} else {
  ggsave(filename = fig_ffn, plot = g,  units = "cm", bg = "white")
}


```

# ~~~~~~~~~~~~~~~~ #
# Figure 6001 -  PPK-WRPA Accuracy-vs-Rcvr-by-Peg
# ~~~~~~~~~~~~~~~~ #

```{r}

fignum = 6001
figdesc = "PPK-R10-Accuracy-split by REC"
figfmt = "png"
fig_ffn = paste0(plotdir, fignum,"-", figdesc, ".", figfmt)

alp = .3

axlim = 2.01

g = ggplot(PPK_ALL_COLLATED_R10) 
g = g + lims(x = c(-axlim,axlim), y = c(-axlim,axlim))
g = g + geom_hline(aes(yintercept = 0), color = "red", linetype = "dashed", alpha = alp)
g = g + geom_vline(aes(xintercept = 0), color = "red", linetype = "dashed", alpha = alp)
g = g + geom_circle(aes(x0 = 0, y0=0, r=1), color = "red", linetype = "dashed", alpha = alp)
g = g + geom_circle(aes(x0 = 0, y0=0, r=0.5), color = "red", linetype = "dashed", alpha = alp)

g = g+ geom_point(aes(DEL_LON_avg , DEL_LAT_avg , color = RECEIVER), size = 2) + facet_wrap(~PEG_LAB, nrow = 3)
g = g + labs(x = expression(paste(Delta," Easting (m)")),y = expression(paste(Delta," Northing (m)")))

g = g + scale_color_manual(values = cbbPalette)
g = g + guides(color=guide_legend(title="GNSS Receiver"))

g = g +coord_fixed(ratio=1)
g = g + theme_bw() +
  theme(
    strip.background =element_rect(fill="white"),
    axis.title =  element_text(size = 12),
    legend.position = c(0.87,0.13))
# axis.title = element_text(size = 16))
g

WD = 28
HT = 8/18*28

specdim = F


ggsave(filename = fig_ffn, plot = g, width = WD, height = HT, units = "cm", bg = "white")

if (specdim){
  ggsave(filename = fig_ffn, plot = g, width = WD, height = HT, units = "cm", bg = "white")
} else {
  ggsave(filename = fig_ffn, plot = g,  units = "cm", bg = "white")
}


```

# ~~~~~~~~~~~~~~~~ #
# Figure 6002 -  PPK-R10 Accuracy-at-each-peg-by-receiver
# ~~~~~~~~~~~~~~~~ #

```{r}

fignum = 6002
figdesc = "PPK-R10 Accuracy-at-each-peg-by-receiver"
figfmt = "png"
fig_ffn = paste0(plotdir, fignum,"-", figdesc, ".", figfmt)

alp = .3

axlim = 2.01

g = ggplot(PPK_ALL_COLLATED_WRPA) 
g = g + lims(x = c(-axlim,axlim), y = c(-axlim,axlim))
g = g + geom_hline(aes(yintercept = 0), color = "red", linetype = "dashed", alpha = alp)
g = g + geom_vline(aes(xintercept = 0), color = "red", linetype = "dashed", alpha = alp)
g = g + geom_circle(aes(x0 = 0, y0=0, r=1), color = "red", linetype = "dashed", alpha = alp)
g = g + geom_circle(aes(x0 = 0, y0=0, r=0.5), color = "red", linetype = "dashed", alpha = alp)


g = g + geom_circle(aes(x0 = DEL_LON_avg, y0=DEL_LAT_avg, r=M_PREC, fill = PEG_LAB), linetype=0 , alpha = .5)


g = g+ geom_point(aes(DEL_LON_avg , DEL_LAT_avg, color = PEG_LAB ), size = 2) + facet_wrap(~RECEIVER, nrow = 2)
g = g + labs(x = expression(paste(Delta," Easting (m)")),y = expression(paste(Delta," Northing (m)")))

g = g + scale_color_manual(values = pegPalette)
g = g + scale_fill_manual(values = pegPalette)


g = g + guides(color=guide_legend("Peg"), fill = "none")

g = g +coord_fixed(ratio=1)
g = g + theme_bw() +
  theme(
    strip.background =element_rect(fill="white"),
    axis.title =  element_text(size = 12),
    legend.position = "bottom")
# axis.title = element_text(size = 16))
g

WD = 28
HT = 8/18*28

specdim = F


ggsave(filename = fig_ffn, plot = g, width = WD, height = HT, units = "cm", bg = "white")

if (specdim){
  ggsave(filename = fig_ffn, plot = g, width = WD, height = HT, units = "cm", bg = "white")
} else {
  ggsave(filename = fig_ffn, plot = g,  units = "cm", bg = "white")
}


```


# Examination of precision and accuracy for different PPK methods


# ~~~~~~~~~~~~~~~~ #
# Figure 7001 -  PPK-R10 Accuracy-at-each-peg-by-receiver
# ~~~~~~~~~~~~~~~~ #

```{r}

fignum = 7001
figdesc = "Comparison-of-PPK-Methods"
figfmt = "png"
fig_ffn = paste0(plotdir, fignum,"-", figdesc, ".", figfmt)

PPK_ALL_COLLATED_filt = PPK_ALL_COLLATED %>% 
  filter(REC != "KIS" & 
           !(REC=="TOP" & OCC==3) &
           !(MET=="PPK-R10" & OCC==3))

g = ggplot(PPK_ALL_COLLATED_filt)
g = g + geom_hline(aes(yintercept = 0.5), color = "red", linetype="dashed")
g = g + geom_hline(aes(yintercept = 1), color = "red", linetype="dashed")
g = g + geom_point(aes(as.character(OCC), M_ACC_float, size = M_PREC_float), color = "darkgrey") + facet_grid(REC~MET)
g = g + labs(x = "Occupation Number", y = "Accuracy (m)", size = "Precision")
g = g + theme_bw()
g = g + theme(strip.background =element_rect(fill="white"))
g


ggsave(filename = fig_ffn, plot = g,  units = "cm", bg = "white")

```





```{r}

Folder_List = ANL_TBL %>% 
  filter(MET=="PPK-DNVK" & !is.na(ANL_ID) & !is.na(REC) & REC !="KIS") %>% 
  mutate(FolderName = paste0(REC,"-OCC", OCC,"-PEG",PEG )) %>% 
  pull(FolderName)

dn = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/FINAL_PPP_SOLUTIONS/"

for (i in Folder_List){
  d2create = paste0(dn, i)
  dir.create(d2create)
}


```





# Read all the PPP pdf files

```{r}
#read the OCC_TBL - the list of all the occupations
OCC_TBL_ffn = paste0(datadir, "OCC_TBL.RDS")
OCC_TBL = readRDS(OCC_TBL_ffn) 

#filter the table to exclude the KIS receiver and the TOPCONN from Occupations 3-9
OCC_TBL_filt = OCC_TBL %>% 
  filter(REC != "KIS" & !(REC == "TOP" & OCC > 2) & !(REC == "EML" & OCC == 7))

#define the directory where the PDFs from the PPP are stored
PPP_results_dn = paste0(datadir, "FINAL_PPP_SOLUTIONS/")


for (i in 1:nrow(OCC_TBL_filt)){
  
  print(i)
  OCC_UID_curr = OCC_TBL_filt$OCC_UID[i]
  # i = 1
  # OCCNUM = 18
  
  PPP_dn = paste0(PPP_results_dn, OCC_TBL_filt$REC[i], "-OCC", OCC_TBL_filt$OCC[i], "-PEG", OCC_TBL_filt$PEG[i], "/")
  
  dir.exists(PPP_dn)
  
  PPP_ffn = list.files(PPP_dn, pattern = "pdf$", full.names = T)
  
  PPP_results = read_PPP_file(PPP_ffn) %>% mutate(OCC_UID = OCC_UID_curr)
  
  
  if (i==1){
    PPP_results_COLL = PPP_results 
  } else{
    PPP_results_COLL = PPP_results_COLL %>% bind_rows(PPP_results)
  }
  
  
}


PPP_RESULTS_FINAL = OCC_TBL %>% 
  left_join(PPP_results_COLL, by = "OCC_UID") %>% 
  filter(!is.na(UTM_N)) 

PPP_RESULTS_FINAL_sf =PPP_RESULTS_FINAL %>%  
  st_as_sf(coords = c("UTM_E", "UTM_N"), crs = 32760) %>% 
  st_transform(crs = 2193) 

PPP_RESULTS_FINAL_coords = PPP_RESULTS_FINAL_sf %>% 
  st_coordinates() %>% 
  as_tibble()

names(PPP_RESULTS_FINAL_coords) <- c("X_2193","Y_2193")

PPP_RESULTS_FINAL_VAL = PPP_RESULTS_FINAL %>% 
  bind_cols(PPP_RESULTS_FINAL_coords) %>% 
  mutate(
    DEL_X = X_2193 - EASTING_TRUE ,
    DEL_Y = Y_2193 - NORTHING_TRUE,
    DEL_X_SQD = (DEL_X^2),
    DEL_Y_SQD = (DEL_Y^2),
    ACC = sqrt(DEL_X_SQD + DEL_X_SQD),
    PEG_LAB = paste0("Peg ", PEG)
  )

mapview(PPP_RESULTS_FINAL_sf, col = "PEG")

```

plot each peg as a panel


# ~~~~~~~~~~~~~~~~ #
# Figure 3001 -  Accuracy-vs-Rcvr-by-Method
# ~~~~~~~~~~~~~~~~ #

```{r}

fignum = 3001
figdesc = "PPP - Accuracy of Receiver - split by pegs"
figfmt = "png"
fig_ffn = paste0(plotdir, fignum,"-", figdesc, ".", figfmt)

alp = .3

axlim = 2.2

g = ggplot(PPP_RESULTS_FINAL_VAL) 
g = g + lims(x = c(-axlim,axlim), y = c(-axlim,axlim))
g = g + geom_hline(aes(yintercept = 0), color = "red", linetype = "dashed", alpha = alp)
g = g + geom_vline(aes(xintercept = 0), color = "red", linetype = "dashed", alpha = alp)
g = g + geom_circle(aes(x0 = 0, y0=0, r=1), color = "red", linetype = "dashed", alpha = alp)
g = g + geom_circle(aes(x0 = 0, y0=0, r=0.5), color = "red", linetype = "dashed", alpha = alp)

g = g+ geom_point(aes(DEL_X, DEL_Y, color = RECEIVER, shape = RECEIVER), size = 2) + facet_wrap(~PEG_LAB, nrow = 2)
g = g + labs(x = expression(paste(Delta," Easting (m)")),y = expression(paste(Delta," Northing (m)")))
g = g +coord_fixed(ratio=1)
g = g + theme_bw() +
  theme(
    strip.background =element_rect(fill="white"))
# axis.title = element_text(size = 16))
g


ggsave(filename = fig_ffn, plot = g, units = "cm", bg = "white")


```



# ~~~~~~~~~~~~~~~~ #
# Figure 3002 -  Accuracy-vs-Rcvr-by-Method
# ~~~~~~~~~~~~~~~~ #


```{r}


fignum = 3002
figdesc = "PPP - Accuracy of Receiver - split by pegs"
figfmt = "png"
fig_ffn = paste0(plotdir, fignum,"-", figdesc, ".", figfmt)

alp = .3

axlim = 2.2

g = ggplot(PPP_RESULTS_FINAL_VAL) + geom_point(aes(DEL_X, DEL_Y, color = RECEIVER, shape = RECEIVER)) + facet_wrap(~Peg)
g = g + lims(x = c(-3,3), y = c(-3,3))
g = g + geom_hline(aes(yintercept = 0), color = "red", linetype = "dashed")
g = g + geom_vline(aes(xintercept = 0), color = "red", linetype = "dashed")
g = g + geom_circle(aes(x0 = 0, y0=0, r=1), color = "red", linetype = "dashed")
g = g + geom_circle(aes(x0 = 0, y0=0, r=0.5), color = "red", linetype = "dashed")

g = g + labs(x = expression(paste(Delta,"Easting (m)")),y = expression(paste(Delta,"Northing (m)")))
g = g +coord_fixed(ratio=1)
g = g + theme_bw()
g

```



# ~~~~~~~~~~~~~~~~ #
# Figure 3003-  Accuracy-for-each-peg-by-recevier
# ~~~~~~~~~~~~~~~~ #

plot each receiver as a panel

```{r}

fignum = 3003
figdesc = "Accuracy-for-each-peg-by-recevier"
figfmt = "png"
fig_ffn = paste0(plotdir, fignum,"-", figdesc, ".", figfmt)

alp = .3

axlim = 2.2

g = ggplot(PPP_RESULTS_FINAL_VAL, aes(DEL_X, DEL_Y, label =PEG )) 

g = g + geom_text() + facet_wrap(~RECEIVER)

# g = g + geom_point(aes(DEL_X, DEL_Y,  shape = Peg)) + facet_wrap(~REC)
# 
# g = g + geom_point(aes(DEL_X, DEL_Y,  shape = Peg)) + facet_wrap(~REC)


g = g + lims(x = c(-3,3), y = c(-3,3))
g = g + geom_hline(aes(yintercept = 0), color = "red", linetype = "dashed")
g = g + geom_vline(aes(xintercept = 0), color = "red", linetype = "dashed")
g = g + geom_circle(aes(x0 = 0, y0=0, r=1), color = "red", linetype = "dashed")
g = g + geom_circle(aes(x0 = 0, y0=0, r=0.5), color = "red", linetype = "dashed")
g = g + labs(x = expression(paste(Delta,"Easting (m)")),y = expression(paste(Delta,"Northing (m)")))
g = g + theme_bw()
g

g = g + labs(x = expression(paste(Delta," Easting (m)")),y = expression(paste(Delta," Northing (m)")))
g = g +coord_fixed(ratio=1)
g = g + theme_bw() +
  theme(
    strip.background =element_rect(fill="white"))
# axis.title = element_text(size = 16))
g


ggsave(filename = fig_ffn, plot = g, units = "cm", bg = "white")

```



```{r}
PPP_RESULTS_FINAL_ffn = paste0(datadir, "PPP_RESULTS_FINAL.csv")

write_csv(PPP_RESULTS_FINAL, PPP_RESULTS_FINAL_ffn )




```





# FINAL COLLATE

```{r}

MET_vec = c("PPK-WRPA", "PPK-WRPA", "PPK-R10", "PPP")
REC_vec = c("CAR", "EML", "TOP", "JVD", "R10-Rover")
OCC_vec = 1:9
PEG_vec = 1:8



#rEAD THE FINAL rSULTS tABLE

xl_ffn = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/GNSS_DATA_COLLATED.xlsx"
xl_page = "FINAL RESULTS"
xl_rng = "A1:H117"


ANL_TBL = readxl::read_excel(xl_ffn, sheet = xl_page, range = xl_rng) %>% 
  left_join(pegloctab, by = c("PEG"="PegNum")) %>% 
  left_join(REC_DATA, by = c("REC"="CODE"))

resave_OCC_TBL=T
if (resave_OCC_TBL){
  OCC_TBL = ANL_TBL %>% filter(MET == "PPK-DNVK") %>% dplyr::select(!c(1:3))
  
  OCC_TBL_ffn = paste0(datadir, "OCC_TBL.RDS")
  saveRDS(OCC_TBL, OCC_TBL_ffn)
  
} else {
  
  OCC_TBL_ffn = paste0(datadir, "OCC_TBL.RDS")
  OCC_TBL = readRDS(OCC_TBL_ffn)
  
  
  
}
```


#=====================================
#   -----------------------------------------------------------------
# Follow-up Analysis - Figure Series 9000
#   -----------------------------------------------------------------
#=====================================


## 1. What is effect of different occupation times?1

```{r}


MM_VEC = c("05", "10", "20", "40", "00", "00", "00", "00", "00", "00", "00", "00")
HH_VEC = c("00", "00", "00", "00", "01", "02", "03", "04", "06", "08", "10", "12")

OCC_TBL_SEG = readRDS(OCC_TBL_ffn) %>% 
  filter((REC == "JVD" | REC == "EML") & OCC==3)



i=1


for (i in 1:length(HH_VEC)){
  print(paste(HH_VEC[i], MM_VEC[i]))
  csoln = proc_pos_seg("JVD", 3,7,"PPK-DNVK", HH_VEC[i], MM_VEC[i]) 
  csoln_df = t(csoln) %>% as_tibble() %>% 
    mutate(
      SEG = paste0(HH_VEC[i], MM_VEC[i]),
      REC = "JVD") 
  if (i==1){
    SOLN_ALL_JVD = csoln_df
  } else {
    SOLN_ALL_JVD = SOLN_ALL_JVD %>% bind_rows(csoln_df) 
  }
  
}


for (i in 1:length(HH_VEC)){
  print(paste(HH_VEC[i], MM_VEC[i]))
  csoln = proc_pos_seg("EML", 3,3,"PPK-DNVK", HH_VEC[i], MM_VEC[i])
  csoln_df = t(csoln) %>% as_tibble() %>% 
    mutate(
      SEG = paste0(HH_VEC[i], MM_VEC[i]),
      REC = "EML") 
  if (i==1){
    SOLN_ALL_EML = csoln_df
  } else {
    SOLN_ALL_EML = SOLN_ALL_EML %>% bind_rows(csoln_df) 
  }
  
}

for (i in 1:(length(HH_VEC)-2)){
  print(paste(HH_VEC[i], MM_VEC[i]))
  csoln = proc_pos_seg("R10-ROVER", 3,1,"PPK-DNVK", HH_VEC[i], MM_VEC[i])
  csoln_df = t(csoln) %>% as_tibble() %>% 
   mutate(
      SEG = paste0(HH_VEC[i], MM_VEC[i]),
      REC = "R10-ROVER") 
  if (i==1){
    SOLN_ALL_R10_ROVER = csoln_df
  } else {
    SOLN_ALL_R10_ROVER = SOLN_ALL_R10_ROVER %>% bind_rows(csoln_df) 
  }
  
}


SOLN_DIFF_OCC_TIMES = SOLN_ALL_R10_ROVER %>% 
  bind_rows(SOLN_ALL_JVD) %>% 
  bind_rows(SOLN_ALL_EML) %>% 
  mutate(OCC_Time_hours = as.numeric(substr(SEG,1,2)) + as.numeric(substr(SEG,3,4))/60) %>% 
  dplyr::select(OCC_Time_hours, everything()) %>% 
  mutate(across(c(contains("ACC"),contains("PREC")), as.numeric))


SOLN_DIFF_OCC_TIMES_ffn = paste0(datadir, "SOLN_DIFF_OCC_TIMES.RDS")

saveRDS(SOLN_DIFF_OCC_TIMES, SOLN_DIFF_OCC_TIMES_ffn)




SOLN_DIFF_OCC_TIMES$SEG
```

# ~~~~~~~~~~~~~~~~ #
# Figure 9001 -  Effect-of-occupation-time
# ~~~~~~~~~~~~~~~~ #

```{r}
fignum = 9001
figdesc = "Effect-of-occupation-time"
figfmt = "png"
fig_ffn = paste0(plotdir, fignum,"-", figdesc, ".", figfmt)

alp = .3
axlim = 2.01



REC_lookup = readRDS(OCC_TBL_ffn) %>% dplyr::select(REC, RECEIVER) %>% distinct()
REC_lookup$REC[5] = "R10-ROVER"


SOLN_DIFF_OCC_TIMES_ffn = paste0(datadir, "SOLN_DIFF_OCC_TIMES.RDS")
SOLN_DIFF_OCC_TIMES = readRDS(SOLN_DIFF_OCC_TIMES_ffn) %>% left_join(REC_lookup, by = "REC")


g = ggplot(SOLN_DIFF_OCC_TIMES) + geom_point(aes(OCC_Time_hours, M_ACC_float, size = M_PREC_float, color = RECEIVER))

g = g + geom_line(aes(OCC_Time_hours, M_ACC_float,  color = RECEIVER))

g = g + scale_color_manual(values = cbbPalette[c(2,3,5)])

# g = g + lims(x = c(0,5))
g = g + labs(x = "Occupation time (hours)", y = "Position accuracy (m)", color = "Receiver", size = "Precision (m)")


g = g + theme_minimal()
g

g_inset = g + lims(x = c(0,2)) 
g_inset = g_inset + theme(
  legend.position = "none",
  plot.background = element_rect(fill = 'white', color = "white"))

library(cowplot)

whole_plot = ggdraw() + draw_plot(g) + draw_plot(g_inset, x=0.18, y = .4, width = .5, height = .5)
whole_plot

ggsave(filename = fig_ffn, plot = whole_plot,  units = "cm", bg = "white")


```







## 2. Get stats for fixed only2


```{r}







```


## 3. What kind of results do we get without differential correction?3
## 4. Add uncertainty to plots ellipses?4
## 5. How does increasing baseline to 100 km affect positioning?5




```{r}
REC_lookup = readRDS(OCC_TBL_ffn) %>% dplyr::select(REC, RECEIVER) %>% distinct()
# REC_lookup$REC[5] = "R10-ROVER"



PPK_ALL_COLLATED = read_csv(paste0(datadir, "PPK_ALL_COLL.csv"))
PPK_ALL_COLLATED_filt = PPK_ALL_COLLATED %>% 
  filter(REC != "KIS") %>% 
  mutate(M_PREC_float_sq = M_PREC_float^2)

PPK_ALL_COLLATED_filt_smy = PPK_ALL_COLLATED_filt %>% 
  group_by(REC, MET) %>% 
  summarise(
    M_ACC_float_mean = mean(M_ACC_float, na.rm=T),
    M_ACC_float_sumsq= sum(M_PREC_float_sq, na.rm=T)
  ) %>% 
  mutate(
    M_ACC_float_prec_prop = sqrt(M_ACC_float_sumsq)
  ) %>% 
  left_join(REC_lookup, by = "REC") %>% 
  filter(MET != "PPK-R10") %>% 
  mutate(
    CORS = ifelse(MET == "PPK-DNVK", "DNVK (31 km)", "WRPA (83 km)")
  )



```

# ~~~~~~~~~~~~~~~~ #
# Figure 9005 -  Effect-of-longer-baseline
# ~~~~~~~~~~~~~~~~ #

```{r}

fignum = 9005
figdesc = "Effect-of-longer-baseline"
figfmt = "png"
fig_ffn = paste0(plotdir, fignum,"-", figdesc, ".", figfmt)

g = ggplot(PPK_ALL_COLLATED_filt_smy) 

dodge_dist = .2

g = g + geom_point(aes(RECEIVER, M_ACC_float_mean , color = CORS), position = position_dodge(width = dodge_dist))

g = g + geom_errorbar(aes(x = RECEIVER,ymin = M_ACC_float_mean - M_ACC_float_prec_prop , ymax = M_ACC_float_mean + M_ACC_float_prec_prop, color = CORS), width = .4,position = position_dodge(width = dodge_dist))

g = g + labs(x = "GNSS Receiver", y = "Positional accuracy (m)", color = "CORS Station")

g = g + theme_minimal() + theme(axis.text.x = element_text(angle = 90), legend.position = "bottom")
g


ggsave(filename = fig_ffn, plot = whole_plot,  units = "cm", bg = "white")


```


```{r}
ggplot(PPK_ALL_COLLATED) + geom_point(aes(OCC, M_ACC_float, color = MET)) + facet_wrap(~RECEIVER)



```






## 6. How does providing precise clock and ephemeris data affect data?6
## 7. Can we make RTKLIB-demo give same results as EMLID studio?7

## 8. How do you find single âbestâ solution from POS file of many solutions?8


```{r}



REC = "JVD"
OCC = 6
PEG = 3
MET = "PPK-DNVK"

REC = "EML"
OCC = 6
PEG = 8
MET = "PPK-DNVK"

REC = "R10-ROVER"
OCC = 6
PEG = 7
MET = "PPK-DNVK"

REC = "R10-ROVER"
OCC = 7
PEG = 3
MET = "PPK-WRPA"


REC = "CAR"
OCC = 2
PEG = 7
MET = "PPK-R10"

REC = "JVD"
OCC = 1
PEG = 6
MET = "PPK-R10"

REC = "JVD"
OCC = 2
PEG = 4
MET = "PPK-R10"

REC = "JVD"
OCC = 2
PEG = 4
MET = "PPK-DNVK"

REC = "JVD"
OCC = 3
PEG = 7
MET = "PPK-DNVK"



REC = "JVD"
OCC = 6
PEG = 3
MET = "PPK-DNVK"



REC = "EML"
OCC = 6
PEG = 8
MET = "PPK-DNVK"
# construct the POS ffn


POS_ffn_stub = "C:/Users/McMillanAn/OneDrive - MWLR/Projects/PRJ3820-DOC-GNSS/data/FINAL_SOLUTIONS/"

POS_ffn_sdn = paste0(REC,"-OCC",OCC,"-P",PEG,"-",MET,".POS")
POS_ffn = paste0(POS_ffn_stub, POS_ffn_sdn)

print(POS_ffn)  
file.exists(POS_ffn)

#these are the lines of code from "qual_based_solution"

POS_data_mdf = read_POS(POS_ffn, FMT_OPT = 5)

POS_data_with_COORDS = convert_crs_df(POS_data_mdf, src_crs = 4326, dst_crs = 2193, 
                                      input_coord_labs = c("Lon_DD", "Lat_DD"),
                                      output_coord_labs = c("LON", "LAT")) 

known_coords = get_peg_loc(PEG)
POS_data_with_COORDS = add_diff_from_known(POS_data_with_COORDS, known_coords =   known_coords) %>%   mutate(
  melap = (as.numeric(UTC_TIME_PX) - as.numeric(UTC_TIME_PX[1]))/60,
  sdneu = sqrt(sdn^2 + sde^2 + sdu^2    ))

POS_data_stats = calc_POS_data_stats(POS_data_with_COORDS, known_coords = known_coords)   

best_linenum = POS_data_with_COORDS %>% 
  mutate(linenum = 1:nrow(.)) %>% 
  filter(Q==1) %>% 
  slice(which.min(ratio)) %>% 
  pull(linenum)

print(paste('best line', best_linenum, 'of ', nrow(POS_data_with_COORDS),'lines'))
print(paste('best solution after', POS_data_with_COORDS$melap[best_linenum], "minutes"))
print(paste('best solution is', POS_data_with_COORDS$DEL_LATLON[best_linenum], "m"))
print(paste('ratio:', POS_data_with_COORDS$ratio[best_linenum]))



ggplot(POS_data_with_COORDS) + geom_point(aes(melap,sdneu )) + geom_vline(aes(xintercept = POS_data_with_COORDS$UTC_TIME_PX[POS_data_sel_lng_best_sdneu]))

best_position = POS_data_with_COORDS$DEL_LATLON[POS_data_sel_lng_best_sdneu]


best_soln = slice(POS_data_with_COORDS, best_linenum)



```

# ~~~~~~~~~~~~~~~~ #
# Figure 9008 -  Best Solution
# ~~~~~~~~~~~~~~~~ #

```{r}
fignum = 9008
figdesc = "PPK-DNVK-Accuracy-for-each-occupation-by-receiver"
figfmt = "png"
fig_ffn = paste0(plotdir, fignum,"-", figdesc, ".", figfmt)

alp = .3
axlim = 2.01


POS_data_with_COORDS = POS_data_with_COORDS %>% 
  mutate(SolutionType = case_when(
    Q==1 ~ "Fixed",
    Q==2 ~ "Float",
    Q==5 ~ "Single",
  ))


g = ggplot(POS_data_with_COORDS)
g = g + lims(x = c(-axlim,axlim), y = c(-axlim,axlim))
g = g + geom_hline(aes(yintercept = 0), color = "red", linetype = "dashed", alpha = alp)
g = g + geom_vline(aes(xintercept = 0), color = "red", linetype = "dashed", alpha = alp)
g = g + geom_circle(aes(x0 = 0, y0=0, r=1), color = "red", linetype = "dashed", alpha = alp)
g = g + geom_circle(aes(x0 = 0, y0=0, r=0.5), color = "red", linetype = "dashed", alpha = alp)


# 
# + geom_point(aes(melap,DEL_LATLON , color=as.character(Q))) + geom_vline(aes(xintercept = POS_data_with_COORDS$UTC_TIME_PX[POS_data_sel_lng_best_sdneu]))

g= g + geom_point(aes(DEL_LON , DEL_LAT ), color = "cyan") + facet_wrap(~SolutionType) + geom_vline(aes(xintercept = 0))+ geom_hline(aes(yintercept = 0))

g
g = g + geom_point(data = best_soln, aes(DEL_LON, DEL_LAT), color = "black" )



g = g + lims(x = axlims, y = axlims)
g = g + labs(x = expression(paste(Delta," Easting (m)")),y = expression(paste(Delta," Northing (m)")), color = "Quality")

g = g +coord_fixed(ratio=1)
g

g = g + theme_bw() +
  theme(
    strip.background =element_rect(fill="white"),
    axis.title =  element_text(size = 12),
    legend.position = "bottom")
# axis.title = element_text(size = 16))
g

WD = 28
HT = 8/18*28

specdim = F


ggsave(filename = fig_ffn, plot = g, width = WD, height = HT, units = "cm", bg = "white")
```


```{r}
# plot time series of the SD
POS_data_sel_lng = POS_data_with_COORDS %>% 
  filter(age>=0) %>%
  dplyr::select(melap, contains("sd"), nvsv, age,ratio,DEL_LATLON, Q) %>% 
  gather(key,value, -melap,-Q) 


#find the lowest point of sdneu

melap_best = POS_data_with_COORDS$melap[POS_data_sel_lng_best_sdneu]

# 
# ggplot(POS_data_sel_lng) + geom_point(aes(melap, value, color = as.character(Q))) + facet_wrap(~key, scales = "free_y") + geom_vline(aes(xintercept = melap_best))



```



## 9. Do the âSingleâ Solutions get included into the POS file?9
## 10. Does the PPP pos file provide any more information that we donât get from the PDF?10



